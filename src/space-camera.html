<dom-module id="space-camera">
  <template>
    <style>
      :host {
        /*display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;*/
      }
    </style>

    <slot></slot>

  </template>

  <script>
    class ViewPort {
      constructor(x, y, s) {
        this.x = x;
        this.y = y;
        this.s = s;
      }

      move(x, y) {
        return new ViewPort(this.x + x, this.y + y, this.s);
      }

      zoom(ds, ex, ey){
        let xShift = (ex - this.x) * (1 - ds);
        let yShift = (ey - this.y) * (1 - ds);
        return new ViewPort(this.x + xShift, this.y + yShift, this.s * ds);
      }
    }

    class SpaceCamera extends Polymer.Element {

      static get is() {
        return 'space-camera';
      }

      static get properties() {
        return {
          coordinates: {
            type: ViewPort,
            value: function () {
              return new ViewPort(0, 0, 1);
            },
            observer: "_updateView"
          },
          buffer: {
            type: Object,
            value: function () {
              return {}
            }
          }
        };
      }

      moveViewport(e) {
        if (this.tapZoom)            //todo move this maybe??
          return;
        this.set("coordinates", this.coordinates.move(e.detail.ddx, e.detail.ddy));
      }

      checkTaps(e) {
        if (e.touches.length !== 2)
          return;
        this.tapZoom = true;

        let dx = e.touches[0].clientX - e.touches[1].clientX;
        let dy = e.touches[0].clientY - e.touches[1].clientY;
        let d = Math.sqrt(dx * dx + dy * dy);

        if (this.buffer.d) {
          let ds = d / this.buffer.d;
          let cx = e.touches[1].clientX + dx / 2;
          let cy = e.touches[1].clientY + dy / 2;
          this._zoomViewport(ds, cx, cy);
        }
        this.buffer.d = d;
      }

      removeTaps() {
        this.tapZoom = false;
        this.buffer.d = null;
      }

      checkScroll(e) {
        let ds = 1 - (e.deltaY / 1000);
        this._zoomViewport(ds, e.x, e.y);
      }

      _zoomViewport(ds, sx, sy) {
        this.set("coordinates", this.coordinates.zoom(ds, sx - window.innerWidth / 2, sy - window.innerHeight / 2));
      }

      _updateView(c) {
        let matrix = [c.s, 0, 0, c.s, c.x, c.y];
        this.style.transform = "matrix(" + matrix.join(",") + ")";
      }
    }

    window.customElements.define(SpaceCamera.is, SpaceCamera);
  </script>
</dom-module>