<link rel="import" href="indexed-mirror.html">
<link rel="import" href="firebase-on.html">
<link rel="import" href="fire-data.html">
<link rel="import" href="fire-auth.html">

<dom-module id="app-data">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>

    <!-- <firebase-on id="activeSketchDB"
                 active="[[_validateName(newState.persistent.user.uid, newState.session.route.segments.0)]]"
                 result="{{activeSketchServed}}"
                 path="/users/[[newState.persistent.user.uid]]/sketches/[[newState.session.route.segments.0]]"></firebase-on>
    
    <firebase-on id="activeSketchListDB" write-only
                 active="[[_BOOL(newState.persistent.user.uid)]]"
                 path="/users/[[newState.persistent.user.uid]]/sketches"></firebase-on> -->

    <fire-data id="currentSketch"></fire-data>
    <fire-data id="sketchList"></fire-data>
    <fire-data id="allSketches"></fire-data>

    <fire-auth id="auth"></fire-auth>

  </template>
  <script>
    class AppData extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return "app-data";
      }

      static get properties() {
        return {
          activeSketchServed: {
            type: Object,
            observer: "_activeSketchServedChanged"
          },
          state: Object,
          user: Object,
          sketchId: {
            type: String,
            observer: '_readServerSketch'
          },
          currentSketch: {
            type: Object,
            // observer: "_writeUserSketch"
          },
          sketchList: {
            type: Object,
            // observer: "_writeUserSketchList"
          },
          // sketchFluid: {
          //   type: Object,
          //   computed: "_getFluidActiveSketch(state.now.sketchFluid)",
          //   observer: "saveChangesDebounced"
          // },
          actionType: String
        };
      }

      static get observers() {
        return [
          "saveChangesDebounced(state.now.sketchFluid)",
        ]
      }

      constructor() {
        super();
        window.addEventListener('app-connected', this._appConnected.bind(this));
        // window.addEventListener('online',             this._appOnline.bind(this));
        // window.addEventListener('offline',            this._appOffline.bind(this));

        window.addEventListener('data-write-sketch', this._writeSketch.bind(this));
        window.addEventListener('data-write-sketchlist', this._writeSketchlist.bind(this));
        this._ref = firebase.database().ref();

        // this._writeUserSketch = _.throttle((sketch) => {
        //   if (navigator.onLine && this.user) {
        //     this.$.currentSketch.write(sketch);
        //     console.log('sketch written');
        //   }
        // }, 1000);
      }

      async _appConnected() {
        this.user = await this._checkUser();

        let currSketchPromise, sketchListPromise;
        if (this.user) {
          this.fire('state-user-in', this.user);
          currSketchPromise = this._readServerSketch();
          sketchListPromise = this._readSketchList();
        } else {
          this.fire('state-user-out');
          currSketchPromise = Promise.resolve();
          sketchListPromise = Promise.resolve();
        }

        await sketchListPromise;
        this.fire('app-data-loaded');
        this.fire('state-system-message', 'All data loaded!');
      }

      // _getFluidActiveSketch(sketchFluid) {
      //   return sketchFluid;
      // }

      _sketchListServedChanged(sketchList) {
        this.fire("new-sketch-list", sketchList);
      }

      _activeSketchServedChanged(sketch) {
        this.fire("new-sketch-data", sketch);
      }

      //      _noDataForSketch(){
      //        this.fire("system-message", "No data found for this user: "+ this.state.now.user.displayName + "\n for this sketchID: "+ this.state.now.session.sketchID);
      //this.fire("state-change-route", undefined);
      //      }
      //

      async signIn() {
        try {
          const result = await this.$.auth.signIn();
          if (result.user) {
            const user = AppData.makeUser(result.user);
            this.fire('state-user-in', user);
            this._readUserSketch(this.sketchId);
            this._readUserSketchList(user);
          }
        } catch (err) {
          throw new Error(err);
        }
      }

      async signOut() {
        try {
          await this.$.auth.signOut();
          this.navigate('unsaved');
          this.fire('state-user-out');
          this.fire('state-server-sketch', {
            info: {
              sketchName: 'unsaved'
            }
          });
          this.fire('state-server-sketchlist', null);
        } catch (err) {
          throw new Error(err);
        }
      }

      static makeUser(user) {
        if (!user)
          return user;
        return {
          name: user.displayName,
          email: user.email,
          photo: user.photoURL,
          uid: user.uid
        }
      }

      async _checkUser() {
        const user = await this.$.auth.checkUser();
        return AppData.makeUser(user);
      }

      async _readServerSketch() {
        if (!this.user)
          return;
        this.$.allSketches.setPath(`/sketches/${this.sketchId}`);
        const currentSketch = await this.$.allSketches.read();
        if (currentSketch) {
          this.fire('state-server-sketch', currentSketch);
        }
        else {
          this.fire('state-server-sketch', {
            info: {
              sketchName: 'unsaved'
            }
          });
          this.navigate('unsaved');
        }
      }

      async _readSketchList() {
        this.$.sketchList.setPath(`/users/${this.user.uid}/sketches`);
        const sketchList = await this.$.sketchList.read();
        if (sketchList)
          return this.fire('state-server-sketchlist', sketchList);
      }

      _writeUserSketch() {
        this.debounce(() => {
          if (navigator.onLine && this.user && this.sketchId !== 'unsaved') {
            this.$.allSketches.setPath(`sketches/${this.sketchId}`);
            this.$.allSketches.write(this.currentSketch);
            console.log('sketch written');
          }
        }, 200);
      }

      _writeSketchlist(e) {
        const sketchList = e.detail;
        if (navigator.onLine && this.user) {
          this.$.sketchList.write(sketchList);
          this.$.sketchList.setPath(`/users/${this.user.uid}/sketches`);
          console.log('sketchlist written');
        }
      }

      _writeSketch(e) {
        const key = e.detail.key;
        const sketch = e.detail.sketch;
        if (key !== 'unsaved') {
          this.$.allSketches.setPath(`/sketches/${key}`);
          this.$.allSketches.write(sketch);
          console.log('sketch written');
        }
      }

      saveChanges(sketchFluid) {
        if (sketchFluid)
          this.$.activeSketchDB.updateMerge(sketchFluid);
      }

      saveChangesList(sketchFluidList) {
        if (sketchFluidList)
          this.$.activeSketchListDB.updateMerge(sketchFluidList);
      }

      saveChangesDebounced(fluidSnap) {
        this._saveDebouncer = Polymer.Debouncer.debounce(
          this._saveDebouncer,
          Polymer.Async.timeOut.after(33),
          this.saveChanges.bind(this, fluidSnap)
        );
      }

      _validateName(user, name) {
        return user && name && name !== "unsaved";
      }

      _BOOL(one) {
        return !!one;
      }

      _AND(one, two) {
        return !!one && !!two;
      }

      _OR(one, two) {
        return !!one || !!two;
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }));
      }

      debounce(callback, timeout) {
        this._debouncer = Polymer.Debouncer.debounce(
          this._debouncer, // initially undefined
          Polymer.Async.timeOut.after(timeout),
          callback);
      }

      navigate(url) {
        history.pushState({}, null, url);
        window.dispatchEvent(new CustomEvent('location-changed'));
      }
    }
    customElements.define(AppData.is, AppData);
  </script>
</dom-module>