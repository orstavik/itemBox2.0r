<dom-module id="controller-fluid">
  <template>
    <style>
      :host { display: block; }
    </style>
    <slot></slot>
  </template>
  <script>
    class ControllerFluid extends Polymer.Element {

      static get is() {
        return "controller-fluid";
      }

      static get properties() {
        return {
          state: Object,
        };
      }

      static get observers() {
        return ["reduceFluidMatrix(serverSketches)"]
      }

      constructor() {
        super();
        this.addEventListener("change-shapes", this._changeShapes.bind(this));
        this.addEventListener("change-shapes-end", this._changeShapesEnd.bind(this));
        this.addEventListener("delete-selected", this._deleteSelected.bind(this));
      }

      reset() {
        this._fire("snap-change", {type: "reset", fluidActiveSketch: undefined});
      }

      reduceFluidMatrix(serverSketches) {
        //todo here, we can also reduce the rects if we want, and yes, this we want to do!
        let diffSketch = undefined;
        if (!this.state.now.fluidActiveSketch)
          return;
        if (serverSketches && this.state.now.session.sketchName) {
          let serverSketch = serverSketches[this.state.now.session.sketchName];
          diffSketch = Tools.filterDeep(this.state.now.fluidActiveSketch, serverSketch);
          for (let key in diffSketch) {                   //custom algorithm for removing shapes deleted FROM server first.
            if (!serverSketch.shapes[key] && !diffSketch[key].matrix)
              delete diffSketch[key];
          }
        }
        let res = {};
        for (let key in this.state.now.rects) {
          if (this.state.now.activeSketch.shapes[key])
            res[key] = this.state.now.rects[key];
        }
        this.setProperties({"fluidActiveSketch": diffSketch/*, "rects": res*/});
      }

      /*
       todo not implemented now
       _newSketch(e) {
       e.stopPropagation();
       this.set("actionType", e.type);
       console.log("The preservation of the previous state is not supported yet.");
       this.setProperties({
       "session": {sketchName: e.detail.url},
       //          "viewPort": undefined,
       //          "selects": undefined,
       "fluidActiveSketch": undefined
       });
       }
       */
      _changeShapesEnd(e) {
        e.stopPropagation();
        this._fire("snap-change", {type: e.detail, fluidActiveSketch: Object.assign({}, this.state.now.fluidActiveSketch)});
      }

      _changeShapes(e) {
        e.stopPropagation();
        this._fire("snap-change", {type: "shape-matrix-fluid", fluidActiveSketch: Tools.mergeDeepWithNullToDelete(this.state.now.fluidActiveSketch, {shapes: e.detail})});
      }

      _deleteSelected(e) {
        e.stopPropagation();
        let deletes = {};
        for (let key in this.state.now.selects)
          deletes[key] = null;
        this._fire("snap-change", {type: "delete-shape", fluidActiveSketch: Tools.mergeDeepWithNullToDelete(this.state.now.fluidActiveSketch, {shapes: deletes})});
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }
    }
    customElements.define(ControllerFluid.is, ControllerFluid);
  </script>
</dom-module>