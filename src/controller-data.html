<link rel="import" href="indexed-mirror.html">
<link rel="import" href="firebase-on.html">
<link rel="import" href="firebase-loginout.html">

<dom-module id="controller-data">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>

    <indexed-mirror key="systemSketches"
                    data="[[serverSystemSketches]]"
                    stored-data="{{sketchDataFromServer}}"></indexed-mirror>

    <firebase-on id="sketchData"
                 active="[[_validateName(state.now.user, state.now.session.sketchID)]]"
                 result-with-path="{{sketchDataFromServer}}"
                 path="sketches/[[state.now.session.sketchID]]/shapes"></firebase-on>

    <firebase-on id="serverUserSnap"
                 active="[[_BOOL(state.now.user)]]"
                 path="/users/[[state.now.user.uid]]"
                 result="{{serverUserSnap}}"
                 on-found-no-data="_newUser"></firebase-on>

    <firebase-loginout id="auth" user="{{serverUser}}"></firebase-loginout>

  </template>
  <script>
    class ControllerData extends Polymer.Element {
      static get is() {
        return "controller-data";
      }

      static get properties() {
        return {
          serverUser: {
            type: Object,
            observer: "_serverUserChanged"
          },
          sketchDataFromServer: {
            type: Object,
            observer: "_sketchDataFromServerChanged"
          },
          serverUserSnap: {
            type: Object,
            observer: "_serverUserSnapChanged"
          },
          state: Object,
          fluidActiveSketch: {
            type: Object,
            computed: "_getFluidActiveSketch(state.now.fluidActiveSketch)",
            observer: "saveChangesDebounced"
          },
          actionType: String
        };
      }

      constructor() {
        super();
        this._ref = firebase.database().ref();
      }

      _getFluidActiveSketch(fluidActiveSketch) {
        return fluidActiveSketch;
      }

      _serverUserSnapChanged(userData) {
        this._fire("new-user-data", userData);
      }

      _serverUserChanged(user) {
        user = !user ? null : {
          displayName: user.displayName,
          email: user.email, 
          emailVerified: user.emailVerified,
          isAnonymous: user.isAnonynous,
          photoURL: user.photoURL,
          refreshToken: user.refreshToken,
          uid: user.uid
        };
        this._fire("new-user", user);
      }

      _sketchDataFromServerChanged(sketch) {
        this._fire("new-sketch-data", sketch ? Tools.setInNoCheck({}, sketch.path, sketch.result) : undefined);
      }

      signIn() {
        this.$.auth.signIn();
      }

      signOut() {
        this.$.auth.signOut();
      }

      _newUser(e) {
        this.$.serverUserSnap.updateOverwrite({
          registered: firebase.database.ServerValue.TIMESTAMP
        });
        this._fire("system-message", "Welcome new user!");
      }

      saveChanges(fluidActiveSketch) {
        if (!fluidActiveSketch)
          return;
        let activeShapes = fluidActiveSketch.shapes;
        let filteredShapes = {};
        for (let key in activeShapes)
          filteredShapes[key] = activeShapes[key];
        let permissionData = Object.assign({}, fluidActiveSketch);
        permissionData.shapes = undefined;
        let sketches = {
          sketches: {}
        };
        sketches.sketches[this.state.now.session.sketchID] = permissionData;
        this.$.serverUserSnap.updateMerge(sketches);
        this.$.sketchData.updateMerge(filteredShapes);
      }

      saveChangesDebounced(fluidSnap) {
        this._saveDebouncer = Polymer.Debouncer.debounce(
          this._saveDebouncer,
          Polymer.Async.timeOut.after(33),
          this.saveChanges.bind(this, fluidSnap)
        );
      }

      _validateName(user, name) {
        return user && name && name !== "unsaved";
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }));
      }

      _BOOL(one) {
        return !!one;
      }

      _AND(one, two) {
        return !!one && !!two;
      }

      _OR(one, two) {
        return !!one || !!two;
      }
    }
    ControllerData.__pushCounter = new Date().getTime();
    customElements.define(ControllerData.is, ControllerData);
  </script>
</dom-module>