<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="firebase-on.html">
<link rel="import" href="firebase-loginout.html">

<dom-module id="controller-data">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <!--<app-indexeddb-mirror key="systemSketches"-->
    <!--data="{{serverSystemSketches}}"-->
    <!--persisted-data="{{systemSketches}}"></app-indexeddb-mirror>-->

    <firebase-on id="sketchData"
                 active$="[[_AND(state.A.0.user, state.A.0.route.path.s0)]]"
                 result-with-path="{{sketchDataFromServer}}"
                 path="sketches/[[state.A.0.route.path.s0]]/shapes"></firebase-on>

    <firebase-on id="serverUserSnap"
                 active$="[[_BOOL(state.A.0.user)]]"
                 path="/users/[[state.A.0.user.uid]]"
                 result="{{serverUserSnap}}"
                 on-found-no-data="_newUser"></firebase-on>
    <firebase-loginout id="auth" user="{{serverUser}}"></firebase-loginout>
  </template>
  <script>

    class ControllerData extends Polymer.Element {
      static get is() {
        return "controller-data";
      }

      static get properties() {
        return {
          serverUser: Object,
          sketchDataFromServer: Object,
          serverUserSnap: Object,
          mergedServerUserSnap: {
            type: Object,
            computed: "_makeMergedServerUserSnap(serverUserSnap, serverUser)"
          },
          serverSnap: {
            type: Object,
            computed: "_makeSnap(mergedServerUserSnap, sketchDataFromServer)",
            observer: "_newServerSnap"
          },
          state: {
            type: Object,
            observer: "_stateChanged"
          },
          actionType: String
        };
      }

      constructor() {
        super();
        this._ref = firebase.database().ref();
      }

      _newServerSnap(C) {
        this._fire("snap-change", {type: this.actionType, snap: C});
      }

      _makeMergedServerUserSnap(serverUserSnap, serverUser) {
        this.set("actionType", "user-loaded");
        return Tools.mergeDeepWithNullToDelete(serverUserSnap, {user: serverUser});
      }

      _makeSnap(mergedServerUserSnap, sketchDataFromServer) {
        let sketchSnap = sketchDataFromServer ? Tools.setInNoCheck({}, sketchDataFromServer.path, sketchDataFromServer.result) : undefined;
        if (sketchSnap)
          this.set("actionType", "sketch-updated");
        return Tools.mergeDeepWithNullToDelete(mergedServerUserSnap, sketchSnap);
      }

      signIn() {
        this.$.auth.signIn();
      }

      signOut() {
        this.$.auth.signOut();
      }

      _newUser(e) {
        this.$.serverUserSnap.updateOverwrite({registered: firebase.database.ServerValue.TIMESTAMP});
        this._fire("system-message", "Welcome new user!");
      }

      updateChanges(changes) {
        this.$.serverUserSnap.updateMerge(changes);
      }


      _stateChanged(state) {
//        let D = Object.assign({}, history[0]);
//        delete D.viewPort;
//        delete D.route;
//        delete D.user;
//        delete D.selecteds;
        console.log("store this?");
        console.log(state.filteredHistory);
//        debounce(storeData, 2000);
//        debugger;
//        let toBeServified = Tools.filterDeep(D, this.userSnap);
//        toBeServified.viewPort = null;
//
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }

      _BOOL(one) {
        return !!one;
      }

      _AND(one, two) {
        return !!one && !!two;
      }

      _OR(one, two) {
        return !!one || !!two;
      }
    }
    ControllerData.__pushCounter = new Date().getTime();
    customElements.define(ControllerData.is, ControllerData);
  </script>
</dom-module>