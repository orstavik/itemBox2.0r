<link rel="import" href="../bower_components/iron-location/iron-location.html">

<dom-module id="app-router">
  <template>
    <iron-location id="ironLocation" on-location-changed="_ironLocationChanged"></iron-location>
  </template>
  <script>
    class AppRouter extends Polymer.Element {

      static get is() {
        return "app-router";
      }

      static get property() {
        return {
          route: Object
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this._routeChange();
      }

      _ironLocationChanged(e) {
        e.stopPropagation();
        this._routeChange();
      }

      setUrl(url) {
        if (AppRouter.parseUrl(location).url !== url) {
          window.history.pushState({}, null, url);
          this._routeChange();
        }
      }

      _routeChange() {
        let route = AppRouter.parseUrl(location);
        this.set("route", route);
        this._fire("route-changed", route);
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }

      static parseUrl(location) {
        let res = {
          path: location.pathname.substr(1),
          search: location.search.substr(1),
          hash: location.hash.substr(1),
          url: AppRouter.pathSearchHashToURL(location.pathname, location.search, location.hash)
        };
        if (res.path)
          res.segments = res.path.split("/").filter(item => item !== "");
        if (res.search) {
          res.queries = {};
          res.search.split("&").map(function (q) {
            let pair = q.split("=");
            res.queries[pair[0]] = pair[1];
          });
        }
        return res;
      }

      static pathSearchHashToURL(path, search, hash) {
        return (path || "") + (search || "") + (hash || "");
      }
    }
    customElements.define(AppRouter.is, AppRouter);
  </script>
</dom-module>