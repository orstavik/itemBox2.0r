<link rel="import" href="shape-object.html">

<dom-module id="shape-plain">
  <template>
    <style>
      :host {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        pointer-events: none;
      }
    </style>

      <template is="dom-repeat" items="[[shapesArray]]">
        <shape-object id$="[[item.key]]"
                      selected$="[[item.value.selected]]"
                      matrix-data="[[item.value.matrix]]"

                      on-down="_select"
                      on-up="_up"
                      on-new-selection="_select"></shape-object>
      </template>

  </template>

  <script>

    class ShapePlain extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return "shape-plain";
      }

      static get properties() {
        return {
          shapes: Object,
          shift: {
            type: Boolean,
            value: false
          },
          shapesArray: {
            type: Array,
            computed: "_toArray(shapes)"
          }
        }
      }

      _toArray(shapes) {
        return Object.keys(shapes).map(function (key) {
          return {key: key, value: shapes[key]};
        });
      }

      constructor() {
        super();
        window.addEventListener("keydown", function (e) {
          if (e.key === "Shift")
            this.shift = true;
        }.bind(this));
        window.addEventListener("keyup", function (e) {
          if (e.key === "Shift")
            this.shift = false;
        }.bind(this));
      }

      _select(e) {
        e.stopPropagation();
        if (e.detail.sourceEvent instanceof Touch)
          this.selectionTimer = setTimeout(function () {
            this._fire("select", e.detail.sourceEvent.target.id);
            this.selectionTimer = undefined;
          }.bind(this), 600);
        else {
          if (!this.shift)
            this._fire("deselect-all");
          this._fire("select", e.target.id);
        }
      }

      _up(e) {
        e.stopPropagation();
        if (this.selectionTimer) {
          clearTimeout(this.selectionTimer);
          this._fire("select", e.target.id);
        }
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }
    }
    customElements.define(ShapePlain.is, ShapePlain);
  </script>
</dom-module>