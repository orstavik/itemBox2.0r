<dom-module id="shape-object">
  <template>
    <style>
      :host {
        position: absolute;
        pointer-events: none;
      }
      :host([selected]) {
        z-index: 1;
      }
      /*:host(:not([selected])) { FOR IVAR
        z-index: 11;
      }*/
      #body {
        pointer-events: auto;
      }
      #innerBody {
        box-sizing: border-box;
        width: 50px;
        height: 50px;
        border-radius: 0 50% 50% 50%;
        transform: rotate(45deg);
        background: forestgreen;
        border: 1px solid darkgreen;
        pointer-events: none;
      }
      :host([selected]) #innerBody {
        border: 2px solid black;
      }
    </style>

    <div id="body" on-down="_select" on-up="_up">
      <div id="innerBody"></div>
    </div>

  </template>

  <script>

    class Rectangle {
      constructor(rect) {
        this.left = rect.left;
        this.right = rect.right;
        this.top = rect.top;
        this.bottom = rect.bottom;
        this.width = rect.width;
        this.height = rect.height;
        this.center = {
          x: (this.left + this.right) / 2,
          y: (this.top + this.bottom) / 2
        };
      }
    }
    
    class TransformableRectangle extends Rectangle {
      constructor(rect, angle, sx, sy) {
        super(rect);
        this.scale = {
          x: sx / Math.abs(sx),
          y: sy / Math.abs(sy)
        };
        this.angle = angle;
      }
    }

    class ShapeObject extends Polymer.GestureEventListeners(Polymer.Element) {

      static get is() {
        return "shape-object";
      }

      static get properties() {
        return {
          selected: {
            type: Boolean,
            value: false,
            observer: "_notifyUI",
            reflectToAttribute: true
          },
          matrixData: {
            type: Object,
            value: ShapeObject._randomMatrixData              //todo MatrixData as an object??
          },
          rect: Object
        }
      }

      connectedCallback() {
        super.connectedCallback();
        window.addEventListener("resize", this._notifyUI.bind(this));
        this.update(this.matrixData);
        setTimeout(this._notifyUI.bind(this), 0);
      }

      _notifyUI() {
        this.rect = new Rectangle(this.$.body.getBoundingClientRect());
        let info = {
          id: this.id,
          rect: this.rect,
          matrix: this.matrixData,
          selected: this.selected
        };
        this._fire("shape-location", info);
      }

      _select(e) {
        e.stopPropagation();
        if (e.detail.sourceEvent instanceof Touch)
          this.selectionTimer = setTimeout(function () {
            this._fire("new-selection", {shape: this.id, multi: true});
            this.selectionTimer = undefined;
          }.bind(this), 600);
        else
          this._fire("new-selection", {shape: this.id, multi: false});
      }

      _up(e) {
        e.stopPropagation();
        if (this.selectionTimer) {
          clearTimeout(this.selectionTimer);
          this._fire("new-selection", {shape: this.id, multi: false});
        }
      }

      update(m) {
        this.set("matrixData", m);
        this.$.body.style.transform = ShapeObject._computeMatrix(m);
        this._notifyUI();
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }

      static _computeMatrix(m) {
        let matrix = [
          m.sx * Math.cos(m.a),
          m.sx * Math.sin(m.a),
          -m.sy * Math.sin(m.a),
          m.sy * Math.cos(m.a),
          m.x,
          m.y
        ];
        return "matrix(" + matrix.join(",") + ")";
      }

      static _randomMatrixData() {
        return {
          x: Math.random() * (window.innerWidth - 100) - window.innerWidth / 2 + 50,
          y: Math.random() * (window.innerHeight - 100) - window.innerHeight / 2 + 50,
          sx: 1,
          sy: 1,
          a: Math.random() * Math.PI * 2
        }
      }
    }
    customElements.define(ShapeObject.is, ShapeObject);
  </script>
</dom-module>