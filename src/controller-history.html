<dom-module id="controller-history">
  <script>
    class ControllerHistory extends Polymer.Element {

      static get is() {
        return "controller-history";
      }

      static get properties() {
        return {
          now: Object,
          A: {                                //history array of all nows
            type: Array,
            computed: "_makeA(now)"
          },
          B: {                                //partial history array of nows: edit events only
            type: Array,
            computed: "_makeB(now)"
          },
          C: {                                //partial history array of nows: system messages only
            type: Array,
            computed: "_makeC(now)"
          },
          D: {                                //partial history array of nows: help messages only
            type: Array,
            computed: "_makeD(now)"
          },
          state: {
            type: Object,
            notify: true
          }
        };
      }

      static get observers() {
        return ["_makeState(A,B,C,D,now)"];  //this has to be done after all the computed, hence it is done via an observer. In Polymer, computed is run first, then observers.
      }

      /*
       * state
       *   A                   arrayOfNows[]
       *   now                 now === A[0]  / "state.now" equals "state.A.0" in the Polymer binding language.
       *    - selects
       *    - rects
       *    - sketches
       ******** (subset views) ***********
       *   editSnaps           partial arrayOfNows[]
       *   systemMessageSnaps  partial arrayOfNows[]
       *   helpMessageSnaps    partial arrayOfNows[]
       **/
      _makeState(A, B, C, D, now) {
        this.set("state", {
          A: A,
          now: now,
          editSnaps: B,
          systemMessageSnaps: C,
          helpMessageSnaps: D
        });
      }

      _makeA(now) {
        return this.A ? [now].concat(this.A) : [now];
      }

      _makeB(now) {
        let t = now.action.type;
        if (t === "new-shape" || t === "delete-shape" || t === "shape-matrix")
          return this.B ? [now].concat(this.B) : [now];
        return this.B;
      }

      _makeC(now) {
        if (now.action.type === "system-message")
          return this.C ? [now].concat(this.C) : [now];
        return this.C;
      }

      _makeD(now) {
        if (now.action.type === "help-message")
          return this.D ? [now].concat(this.D) : [now];
        return this.D;
      }
    }
    customElements.define(ControllerHistory.is, ControllerHistory);
  </script>
</dom-module>