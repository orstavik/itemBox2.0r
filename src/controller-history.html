<dom-module id="controller-history">
  <script>
    class ControllerHistory extends Polymer.Element {

      static get is() {
        return "controller-history";
      }

      static get properties() {
        return {
          now: Object,
          history: {                                //history array of all nows
            type: Array,
            computed: "_makeHistory(now)"
          },
          editHistory: {                            //partial history array of nows: edit events only
            type: Array,
            computed: "_makeEditHistory(now)"
          },
          systemMessageHistory: {                   //partial history array of nows: system messages only
            type: Array,
            computed: "_makeSystemMessageHistory(now)"
          },
          helpMessageHistory: {                     //partial history array of nows: help messages only
            type: Array,
            computed: "_makeHelpMessageHistory(now)"
          },
          activeSketch: {                           //partial now: the active sketch
            type: Object,
            computed: "_makeActiveSketch(now.sketches, now.session.sketchName, now.fluidActiveSketch, now.selects, now.rects)"
          },
          state: {
            type: Object,
            notify: true
          }
        };
      }

      static get observers() {
        return ["_makeState(history,editHistory,systemMessageHistory,helpMessageHistory,now,activeSketch)"];  //this has to be done after all the computed, hence it is done via an observer. In Polymer, computed is run first, then observers.
      }

      constructor() {
        super();
        this.history = [];
        this.editHistory = [];
        this.systemMessageHistory = [];
        this.helpMessageHistory = [];
      }

      /*
       * state
       *
       *   history
       *    - all                    full arrayOfNows[]
       *    - edits                  partial arrayOfNows[]
       *    - helpMsgs               partial arrayOfNows[]
       *    - systemMsgs             partial arrayOfNows[]
       *
       *   now                       now === history[0]  / ("state.now" equals "state.history.0" Polymer binding).
       *    - selects
       *    - rects
       *    - sketches
       *    - fluidActiveSketch
       *    - activeSketch
       **/
      _makeState(history, editHistory, systemMessageHistory, helpMessageHistory, now, activeSketch) {
        now.activeSketch = activeSketch;
        this.set("state", {
          history: {
            all: history,
            edits: editHistory,
            systemMsgs: systemMessageHistory,
            helpMsgs: helpMessageHistory,
          },
          now: now,
        });
      }

      _makeHistory(now) {
        return [now].concat(this.history);
      }

      _makeEditHistory(now) {
        let t = now.action.type;
        if (t === "new-shape" || t === "delete-shape" || t === "shape-move" || t === "shape-scale" || t === "shape-rotate")
          return [now].concat(this.editHistory);
        return this.editHistory;
      }

      _makeSystemMessageHistory(now) {
        if (now.action.type === "system-message")
          return [now].concat(this.systemMessageHistory);
        return this.systemMessageHistory;
      }

      _makeHelpMessageHistory(now) {
        if (now.action.type === "help-message")
          return [now].concat(this.helpMessageHistory);
        return this.helpMessageHistory;
      }

      _makeActiveSketch(sketches, name, fluidActiveSketch, selects, rects) {
        if (!sketches)
          return undefined;
        let activeSketch = Tools.mergeDeepWithNullToDelete(sketches[name], fluidActiveSketch);
        let mergeableSelects = {};
        for (let key in selects)
          mergeableSelects[key] = {selected: true, rect: rects[key]};
        return Tools.mergeDeepWithNullToDelete(activeSketch, {shapes: mergeableSelects});
      }
    }
    customElements.define(ControllerHistory.is, ControllerHistory);
  </script>
</dom-module>