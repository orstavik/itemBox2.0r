<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-styles/color.html">


<link rel="import" href="ui/app-login.html">
<link rel="import" href="ui/app-sketchlist.html">
<link rel="import" href="ui/tools-button.html">
<link rel="import" href="ui/account-button.html">
<link rel="import" href="ui/tools-item-button.html">
<link rel="import" href="ui/object-viewer.html">
<link rel="import" href="ui/color-palette.html">
<link rel="import" href="ui/app-history.html">
<link rel="import" href="ui/messages-help.html">
<link rel="import" href="ui/messages-system.html">
<link rel="import" href="ui/app-dialog.html">

<link rel="import" href="shape/shape-plain.html">

<link rel="import" href="lib/keyboard-listener.html">

<dom-module id="app-ui">
  <template>
    <style>
      :host {
        height: 100%;
      }
      tools-button {
        --mother-button-size: 50px;
        --mother-button-color: var(--paper-pink-a100);
        --mother-button-icon-color: black;
        position: absolute;
        top: 6px;
        left: 6px;
        z-index: 100;
      }
      tools-item-button {
        --tools-item-button-size: 36px;
        --tools-item-button-color: white;
        --tools-item-button-icon-color: black;
      }
      account-button#account {
        --account-button-size: 50px;
        --account-button-color: white;
        --account-button-icon-color: black;
        position: absolute;
        top: 6px;
        right: 6px;
        z-index: 100;
      }
      account-button#account[signed] {
        --account-button-color: var(--paper-pink-a100);
      }
      #sketchNamePaper {
        display: flex;
        height: 34px;
        align-items: center;
        position: absolute;
        bottom: 16px;
        right: 16px;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 3px;
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.5s, transform 0.4s;
        overflow: hidden;
        z-index: 10;
        font-weight: 400;
      }
      #sketchName {
        margin: 0 16px;
      }
      #saveButton {
        position: relative;
        padding: 5px;
        background-color: var(--paper-green-700);
        color: white;
        cursor: pointer;
      }
      *[hidden] {
        display: none;
      }
      #systemBox {
        display: flex;
        flex-direction: column-reverse;
        position: absolute;
        top: 100vh;
        left: 50vw;
        transform: translateX(-50%);
        z-index: 100;
      }
      #testButtons {
        display: inline-block;
        position: absolute;
        top: 50%;
        right: 0;
        z-index: 100;
        font-size: 10px;
      }
      app-dialog [slot=content] {
        font-size: 12px;
      }
      app-dialog paper-radio-button {
        padding: 6px;
      }
      app-dialog paper-input {
        margin-top: -8px;
      }
      app-dialog paper-button {
        font-size: 14px;
        font-weight: 500;
      }
    </style>

    <keyboard-listener on-key-down="_checkKey" on-key-up="_keyUp" exclude-repeats></keyboard-listener>

    <shape-plain id="shapePlain" state="[[state]]" held-keys="[[heldKeys]]" on-deselect-all="deselect"></shape-plain>

    <paper-material id="sketchNamePaper" hidden$="[[!state.persistent.user]]" status$="[[state.now.savedStatus]]" elevation=1>
      <div id="sketchName">[[state.persistent.currentSketch.info.sketchName]]</div>
      <div id="saveButton" on-tap="_saveSketchDialog" hidden$="[[_isNotUnsaved(state.session.route.segments.0)]]">
        <paper-ripple></paper-ripple>
        <iron-icon icon="add"></iron-icon>
      </div>
    </paper-material>

    <tools-button id="tools" icon="icons:build">
      <tools-item-button id="buttA" menu="Json" child-button icon="icons:settings-ethernet" slot="a">
        <object-viewer json="[[state]]" name="state"></object-viewer>
      </tools-item-button>
      <tools-item-button id="buttB" menu="Palette" child-button icon="image:color-lens" slot="b">
        <color-palette id="palette" color="[[state.session.editColor]]"></color-palette>
      </tools-item-button>
      <tools-item-button id="buttC" menu="History" child-button icon="icons:restore" slot="c"
                         active="{{historyActive}}">
        <app-history history="[[_currentHistory(state.history.sketchEdit, state.session.route.segments.0)]]" parent-active="[[historyActive]]"></app-history>
      </tools-item-button>
    </tools-button>

    <account-button id="account" class="top right" icon="account-circle" signed$="[[_BOOL(state.persistent.user)]]">
      <app-login user="[[state.persistent.user]]">
        <app-sketchlist uid="[[state.persistent.user.uid]]" sketches="[[state.persistent.sketchList]]" current-sketch="[[state.session.route.segments.0]]"></app-sketchListMerged>
      </app-login>
    </account-button>

    <app-dialog id="newDialog">
      <span slot="title">New Sketch</span>

      <paper-input slot="content" id="newSketchName" label="Sketch Name" required error-message="Name your sketch!"></paper-input>
      <paper-checkbox slot="content" id="newSketchClear">Clear canvas</paper-checkbox>
      <paper-radio-group slot="content" id="newSketchPermissions" selected="private">
        <paper-radio-button name="private">Private</paper-radio-button>
        <paper-radio-button name="read">Public(read)</paper-radio-button>
        <paper-radio-button name="edit">Public(edit)</paper-radio-button>
      </paper-radio-group>

      <paper-button id="close" slot="actions" on-tap="_closeDialog">Close</paper-button>
      <paper-button id="submit" slot="actions" on-tap="_submitNewDialog">Create</paper-button>
    </app-dialog>

    <app-dialog id="saveDialog">
      <span slot="title">Save Sketch</span>

      <paper-input slot="content" id="saveSketchName" label="Sketch Name" required error-message="Name your sketch!"></paper-input>
      <paper-radio-group slot="content" id="saveSketchPermissions" selected="private">
        <paper-radio-button name="private">Private</paper-radio-button>
        <paper-radio-button name="read">Public(read)</paper-radio-button>
        <paper-radio-button name="edit">Public(edit)</paper-radio-button>
      </paper-radio-group>

      <paper-button id="close" slot="actions" on-tap="_closeDialog">Close</paper-button>
      <paper-button id="submit" slot="actions" on-tap="_submitSaveDialog">Save</paper-button>
    </app-dialog>

    <app-dialog id="editDialog">
      <span slot="title">Edit Sketch</span>

      <paper-input slot="content" id="editSketchName" label="Sketch Name" required error-message="Name your sketch!" value="[[state.persistent.currentSketch.info.sketchName]]"></paper-input>
      <paper-radio-group slot="content" id="editSketchPermissions" selected="[[state.persistent.currentSketch.info.permissions]]">
        <paper-radio-button name="private">Private</paper-radio-button>
        <paper-radio-button name="read">Public(read)</paper-radio-button>
        <paper-radio-button name="edit">Public(edit)</paper-radio-button>
      </paper-radio-group>

      <paper-button id="close" slot="actions" on-tap="_closeDialog">Close</paper-button>
      <paper-button id="submit" slot="actions" on-tap="_submitEditDialog">Save</paper-button>
    </app-dialog>

    <app-dialog id="deleteDialog">
      <span slot="title">Delete Sketch</span>

      <span slot="content" style="font-size: 14px;">Do you really want to delete "[[state.persistent.currentSketch.info.sketchName]]"?</span>

      <paper-button id="close" slot="actions" on-tap="_closeDialog">Close</paper-button>
      <paper-button id="submit" slot="actions" on-tap="_submitDeleteDialog">Delete</paper-button>
    </app-dialog>

    <messages-help messages="[[state.history.helpMessages]]" count=3></messages-help>
    <messages-system messages="[[state.history.systemMessages]]" count=5></messages-system>
  </template>

  <script>
    class appUi extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return "app-ui";
      }

      static get properties() {
        return {
          state: Object,
          firebase: {
            type: Object,
            value: () => firebase
          }
        }
      }

      constructor() {
        super();
        this.addEventListener("new-sketch-dialog", e => this.$.newDialog.open() );
        this.addEventListener("edit-sketch-dialog", e => this.$.editDialog.open({key: e.detail}) );
        this.addEventListener("delete-sketch-dialog", e => this.$.deleteDialog.open({key: e.detail}) );
      }

      _currentHistory(history, id) {
        return history[id];
      }

      _submitNewDialog(e) {
        this._fire("state-save-sketch", {
          clear: this.$.newSketchClear.checked,
          info: {
            sketchName: this.$.newSketchName.value,
            permissions: this.$.newSketchPermissions.selected,
          }
        });
        this.$.newDialog.close();
      }

      _submitSaveDialog(e) {
        this._fire("state-save-sketch", {
          clear: false,
          info: {
            sketchName: this.$.saveSketchName.value,
            permissions: this.$.saveSketchPermissions.selected,
          }
        });
        this.$.saveDialog.close();
      }

      _submitEditDialog(e) {
        this._fire("state-edit-sketch", {
          info: {
            sketchName: this.$.editSketchName.value,
            permissions: this.$.editSketchPermissions.selected,
          },
          key: this.$.editDialog.key
        });
        this.$.editDialog.close();
      }

      _submitDeleteDialog(e) {
        this._fire("state-delete-sketch", {
          key: this.$.deleteDialog.key
        });
        this.$.deleteDialog.close();
      }

      _closeDialog(e) {
        e.target.parentElement.close();
      }

      _saveSketchDialog() {
        this.$.saveDialog.open();
      }

      _deleteSketchDialog(e) {
        this.shadowRoot.appendChild(new DeleteSketchDialog(e.detail));
      }

      deselect() {
        this.$.account.deactivate();
        this.$.tools.deactivate();
      }

      _checkKey(e) {
        this.set("heldKeys", e.detail);
        switch (e.detail.code()) {
          case "Enter":
            this.$.clef.turnKeyRight();
            return;
          case "Tab":
            this.$.clef.turnKeyLeft();
            return;
          case "Backspace":
            this.$.clef.turnModusRight();
            return;
          case "Backquote":
            this.$.clef.turnModusLeft();
            return;
          case "Escape":
            this._fire("deselect-all");
            return;
          case "Delete":
            this._fire("state-delete-shape");
            return;
            //          case "KeyN":
            //            let copy = confirm("Do you want to copy the current sketch?");
            //            this._fire("new-sketch", {url: Tools.genKey(), copy: copy});
            //            return;
            //          case "KeyM":
            //            this._fire("change-shapes", this.getSelectedInfos().map(info => info.mirror()));
            //            return;
            //          case "KeyN":
            //            this._fire("change-shapes", this.getSelectedInfos().map(info => info.center()));
            //            return;
            //          case "PageUp":
            //            this._fire("change-shapes", this.getSelectedInfos().map(info => info.zUp()));
            //            return;
            //          case "PageDown":
            //            this._fire("change-shapes", this.getSelectedInfos().map(info => info.zDown()));
            //            return;
        }
        if (e.detail.ctrl()) {
          if (e.detail.code() === "Digit0")
            this._fire("state-change-viewport", {
              x: 0,
              y: 0,
              s: 1
            });
          //          else if (e.detail.code() === "KeyC")
          //            this.copy();
          //          else if (e.detail.code() === "KeyV")
          //            this.paste();
        }
      }

      _keyUp(e) {
        this.set("heldKeys", e.detail);
      }

      _BOOL(obj) {
        return !!obj;
      }

      _isNotUnsaved(sketchID) {
        return sketchID !== "unsaved";
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }));
      }
    }
    customElements.define(appUi.is, appUi);
  </script>
</dom-module>