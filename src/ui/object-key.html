<link rel="import" href="../styles/css-reset.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<dom-module id="object-key">
  <template>
    <style include="css-reset">
			:host {
				display: block;
        box-sizing: border-box;
        align-items: center;
        padding-left: 14px;
        font-size: 14px;
			}
      #opener {
        visibility: hidden;
        display: inline-block;
        box-sizing: border-box;
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
      #opener[visible] {
        visibility: visible;
      }
      iron-icon {
        --iron-icon-width: 16px;
        --iron-icon-height: 16px;
        --iron-icon-fill-color: var(--paper-indigo-a700);
      }
      #type {
        text-transform: capitalize;
        font-style: italic;
        color: lightgrey;
      }
      #name {
        font-weight: 600;
        margin-right: 6px;
      }
      #primValue.string {
        color: var(--paper-green-800);
      }
      #primValue.string::before, #primValue.string::after {
        content: '"';
      }
      #primValue.number {
        color: var(--paper-red-800);
      }
      #primValue.boolean {
        color: var(--paper-blue-800);
      }
      #primValue.undefined, #primValue.null {
        color: grey
      }
      #objValue:not([hidden]) + #closeBracket {
        padding-left: 20px;
      }
    </style>

    <div id="opener" class$="[[key.type]]" visible$="[[objType]]" on-tap="_toggle">
      <iron-icon icon="add-circle" hidden$="[[active]]"></iron-icon>
      <iron-icon icon="remove-circle-outline" hidden$="[[!active]]"></iron-icon>
    </div>
    <span id="name">[[key.name]]:</span>
    <span id="openBracket" hidden$="[[!objType]]">[[brackets.open]]</span>
    <span hidden$="[[!objType]]">
      <span id="type" hidden$="[[active]]">[[key.type]]</span>
    </span>
    <span id="primValue" class$="[[key.type]]" hidden$="[[objType]]">[[key.value]]</span>
    <div id="objValue" hidden$="[[!active]]">
      <template is="dom-repeat" items="[[_value]]">
        <object-key key="[[item]]"></object-key>
      </template>
    </div>
    <span id="closeBracket" hidden$="[[!objType]]">[[brackets.close]]</span>

  </template>
  <script>
    class ObjectKey extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return "object-key";
      }

      static get properties() {
        return {
					key: Object,
          _value: Array,
          objType: Boolean,
          active: {
            type: Boolean,
            value: false
          },
          brackets: Object
        }
      }

      static get observers() {
        return [
          "_displayKey(key, active)",
          "_useType(key.type)"
        ]
      }

      _displayKey(key, active) {
        if (!key)
          return;

        switch (key.type) {
          case "undefined":
            this.set("key.value", "undefined");
            break;

          case "null":
            this.set("key.value", "null");
            break;
        }

        if (!active)
          return;

        switch (key.type) {
          case "array":
            this.set("_value", key.value.map(function(item, index) {
              var type = typeof(item);
              if (item instanceof Array)
                type = "array";
              else if (item === null)
                type = "null";
              return {
                name: index,
                type: type,
                value: item
              }
            }));
            break;
            
          case "object":
            if (key.name === "user") // SPECIAL CASE!!! INFINITE LOOP :(
              break;

            this.set("_value", Object.keys(key.value).map(function(name) {
              var type = typeof(key.value[name]);
              if (key.value[name] instanceof Array)
                type = "array";
              else if (key.value[name] === null)
                type = "null";
              return {
                name: name,
                type: type,
                value: key.value[name]
              }
            }));
            break;
        }
      }

      _useType(type) {
        switch (type) {
          case "array":
            this.setProperties({
              "brackets": {
                open: "[",
                close: "]"
              },
              "objType": true
            });
            break;
          case "object":
            this.setProperties({
              "brackets": {
                open: "{",
                close: "}"
              },
              "objType": true
            });
            break;
          default:
            this.setProperties({
              "brackets": {
                open: "",
                close: ""
              },
              "objType": false
            });
            break;
        }
      }

      _toggle() {
        this.active = !this.active;
      }
    }
    customElements.define(ObjectKey.is, ObjectKey);
  </script>
</dom-module>