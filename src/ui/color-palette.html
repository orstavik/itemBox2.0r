<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="color-knob.html">

<dom-module id="color-palette">
  <template>
    <style>
      :host {
        display: flex;
        box-sizing: border-box;
        flex-direction: column;
        align-items: center;
        justify-content: space-around;
        padding: 10px 16px 10px;
      }
      #colorPreview {
        display: flex;
        height: 100px;
        width: 260px;
      }
      #colorWrapper {
        display: flex;
        width: 260px;
        margin: 12px 0;
        justify-content: space-between;
      }
      #codeWrapper {
        display: flex;
        justify-content: space-between;
        width: 260px;
      }
      .canvas-box {
        display: inline-flex;
        position: relative;
      }
      .knob {
        background: white;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }
      #slider1Knob, #slider2Knob {
        width: 22px;
        height: 8px;
        border-radius: 4px;
      }
      #boxKnob {
        width: 16px;
        height: 16px;
        border-radius: 8px;
      }
      paper-input {
        width: 60px;
      }
    </style>

    <div id="colorPreview" style$="background-color: [[color]]"></div>

    <div id="codeWrapper">
      <paper-input data-type="hue" label="Hue"
                   error-message="0-360!"
                   on-input="_validate"
                   pattern="(36[0]|3[0-5][0-9]|[12][0-9][0-9]|[1-9]?[0-9])"
                   maxlength="3"
                   value="[[hue]]">
      </paper-input>
      <paper-input data-type="saturation" label="Saturation" 
                   error-message="0-100!"
                   on-input="_validate"
                   pattern="(1[0][0]|[1-9]?[0-9])"
                   maxlength="3"
                   value="[[saturation]]">
        <div slot="suffix">%</div>
      </paper-input>
      <paper-input data-type="lightness" label="Lightness" 
                   error-message="0-100!"
                   on-input="_validate"
                   pattern="(1[0][0]|[1-9]?[0-9])"
                   maxlength="3"
                   value="[[lightness]]">
        <div slot="suffix">%</div>
      </paper-input>
      <paper-input data-type="alpha" label="Alpha" 
                   error-message="0-1!"
                   on-input="_validate"
                   pattern="(0(\.\d+)?|1)"
                   maxlength="4"
                   value="[[alpha]]">
      </paper-input>
    </div>

    <div id="colorWrapper">
      <div class="canvas-box">
        <canvas id="colorSlider1" width="20" height="200"></canvas>
        <color-knob only-y
                    on-y-change="_hueChange"
                    y="[[_calcFromHue(hue)]]">
          <div id="slider1Knob" class="knob"></div>
        </color-knob>
      </div>
      <div class="canvas-box" on-x-change="_lightnessChange" on-y-change="_saturationChange">
        <canvas id="colorBox" width="200" height="200"></canvas>
        <color-knob x="[[_calcFromLightness(lightness)]]"
                    y="[[_calcFromSaturation(saturation)]]">
          <div id="boxKnob" class="knob"></div>
        </color-knob>
      </div>
      <div class="canvas-box">
        <canvas id="colorSlider2" width="20" height="200"></canvas>
        <color-knob only-y
                    on-y-change="_alphaChange"
                    y="[[_calcFromAlpha(alpha)]]">
          <div id="slider2Knob" class="knob"></div>
        </color-knob>
      </div>
    </div>

  </template>

  <script>
    class ColorPalette extends Polymer.Element {
      static get is() {
        return "color-palette";
      }

      static get properties() {
        return {
          hue: {
            type: Number,
            value: 300
          },
          saturation: {
            type: Number,
            value: 100
          },
          lightness: {
            type: Number,
            value: 50
          },
          alpha: {
            type: Number,
            value: 1
          },
          color: {
            type: String,
            computed: "_makeColor(hue,saturation,lightness,alpha)"
          }
        }
      }

      static get observers() {
        return [
          "_drawColorBox(hue,alpha)",
          "_drawColorSlider1(alpha)",
          "_drawColorSlider2(hue,saturation,lightness)"
        ]
      }

      _drawColorBox(h,a) {
        var c = this.$.colorBox.getContext("2d");
        c.clearRect(0,0,c.canvas.width,c.canvas.height);
        var sx = c.canvas.width / 50;
        var sy = c.canvas.height / 50;
        for (var l = 0; l < 50; l++) {
          for (var s = 0; s < 50; s++) {
            c.fillStyle = "hsla("+h+", "+s*2+"%, "+l*2+"%, "+a+")";
            c.fillRect(sx*l, sy*(49-s), sx, sy);
          }
        }
      }

      _drawColorSlider1(a) {
        var c = this.$.colorSlider1.getContext("2d");
        c.clearRect(0,0,c.canvas.width,c.canvas.height);
        var sx = c.canvas.width;
        var sy = c.canvas.height / 360;
        for (var h = 0; h < 360; h++) {
          c.fillStyle = "hsla("+h+", 100%, 50%, "+a+")";
          console.log(h);
          c.fillRect(0, h*sy, sx, sy);
        }
      }

      _drawColorSlider2(h,s,l) {
        var c = this.$.colorSlider2.getContext("2d");
        c.clearRect(0,0,c.canvas.width,c.canvas.height);
        var sx = c.canvas.width;
        var sy = c.canvas.height;
        for (var a = 0; a < 1; a += 0.01) {
          c.fillStyle = "hsla("+h+", "+s+"%, "+l+"%, "+a+")";
          c.fillRect(0, sy*(0.99-a), sx, sy*0.01);
        }
      }

      _makeColor(h,s,l,a) {
        return "hsla("+h+", "+s+"%, "+l+"%, "+a+")";
      }

      _hueChange(e) {
        this.hue = Math.round(e.detail/this.$.colorSlider1.height*360);
      }

      _saturationChange(e) {
        this.saturation = Math.round((1-(e.detail/this.$.colorBox.height))*100);
      }

      _lightnessChange(e) {
        this.lightness = Math.round(e.detail/this.$.colorBox.width*100);
      }

      _alphaChange(e) {
        this.alpha = this._roundTo(1-(e.detail/this.$.colorSlider2.height), 4);
      }

      _calcFromHue(h) {
        return h/360*this.$.colorSlider1.height;
      }

      _calcFromSaturation(s) {
        return (1-s/100)*this.$.colorBox.height;
      }

      _calcFromLightness(l) {
        return l/100*this.$.colorBox.width;
      }

      _calcFromAlpha(a) {
        return (1-a)*this.$.colorSlider2.height;
      }

      _validate(e) {
        if (e.target.validate())
          this[e.target.dataset.type] = e.target.value;
      }

      _roundTo(x,n) {
        var e = Math.pow(10,n);
        return Math.round(x*e)/e;
      }

      // _drawColorWheel(c) {
      //   var sx = c.canvas.width / 202;
      //   var sy = c.canvas.height / 202;
      //   var cx = c.canvas.width / 2;
      //   var cy = c.canvas.height / 2;
      //   var k = 50;
      //   for (var i = 0; i < 360; i++) {
      //     var rad = i/180*Math.PI;
      //     var cos = Math.cos(rad);
      //     var sin = Math.sin(rad);
      //     var x = 0;
      //     var y = 1;
      //     var nx = (cos * x) + (sin * y);
      //     var ny = (cos * y) - (sin * x);
      //     for (var j = 0; j < 100; j++) {
      //       c.fillStyle = "hsl("+i+", "+j+"%, "+k+"%)";
      //       var s = j/100*Math.PI;
      //       s = s<1 ? 1 : s;
      //       c.fillRect(cx-sx*1.5+(nx*sx*j), cy-sy*1.5+(ny*sy*j), s*sx, s*sy);
      //     }
      //   }
      // }
    }
    customElements.define(ColorPalette.is, ColorPalette);
  </script>
</dom-module>