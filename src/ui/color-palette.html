<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="color-knob.html">

<dom-module id="color-palette">
  <template>
    <style>
      :host {
        display: flex;
        box-sizing: border-box;
        flex-direction: column;
        align-items: center;
        justify-content: space-around;
        padding: 16px;
      }
      #colorPreview {
        height: 100px;
        width: 260px;
        position: relative;
        background-image: url("../../img/transparent.jpg");
      }
      #colorPreview>div {
        height: 100%;
      }
      #colorWrapper {
        display: flex;
        width: 260px;
        justify-content: space-between;
      }
      #codeWrapper {
        display: flex;
        width: 260px;
        justify-content: space-between;
        margin: 12px 0;
      }
      .canvas-box {
        display: inline-flex;
        position: relative;
        background-image: url("../../img/transparent.jpg");
        user-select: none;
      }
      .knob {
        background: white;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
        0 1px 5px 0 rgba(0, 0, 0, 0.12),
        0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }
      #slider1Knob, #slider2Knob {
        width: 22px;
        height: 8px;
        border-radius: 4px;
      }
      #boxKnob {
        width: 16px;
        height: 16px;
        border-radius: 8px;
      }
      paper-input {
        width: 60px;
      }
    </style>

    <div id="colorPreview">
      <div style$="background-color: [[color]]"></div>
    </div>

    <div id="codeWrapper">
      <paper-input data-type="hue" label="Hue"
                   error-message="0-360!"
                   on-input="_validate"
                   pattern="(36[0]|3[0-5][0-9]|[12][0-9][0-9]|[1-9]?[0-9])"
                   maxlength="3"
                   value="[[hue]]">
      </paper-input>
      <paper-input data-type="saturation" label="Saturation" 
                   error-message="0-100!"
                   on-input="_validate"
                   pattern="(1[0][0]|[1-9]?[0-9])"
                   maxlength="3"
                   value="[[saturation]]">
        <div slot="suffix">%</div>
      </paper-input>
      <paper-input data-type="lightness" label="Lightness" 
                   error-message="0-100!"
                   on-input="_validate"
                   pattern="(1[0][0]|[1-9]?[0-9])"
                   maxlength="3"
                   value="[[lightness]]">
        <div slot="suffix">%</div>
      </paper-input>
      <paper-input data-type="alpha" label="Alpha" 
                   error-message="0-1!"
                   on-input="_validate"
                   pattern="(0(\.\d+)?|1)"
                   maxlength="3"
                   value="[[alpha]]">
      </paper-input>
    </div>

    <div id="colorWrapper">
      <div class="canvas-box">
        <canvas id="colorSlider1" width="20" height="200"></canvas>
        <color-knob only-y
                    on-y-change="_hueChange"
                    y="[[_calcFromHue(hue)]]">
          <div id="slider1Knob" class="knob"></div>
        </color-knob>
      </div>
      <div class="canvas-box" on-x-change="_lightnessChange" on-y-change="_saturationChange">
        <canvas id="colorBox" width="200" height="200"></canvas>
        <color-knob x="[[_calcFromLightness(lightness)]]"
                    y="[[_calcFromSaturation(saturation)]]">
          <div id="boxKnob" class="knob"></div>
        </color-knob>
      </div>
      <div class="canvas-box">
        <canvas id="colorSlider2" width="20" height="200"></canvas>
        <color-knob only-y
                    on-y-change="_alphaChange"
                    y="[[_calcFromAlpha(alpha)]]">
          <div id="slider2Knob" class="knob"></div>
        </color-knob>
      </div>
    </div>

  </template>

  <script>
    class ColorPalette extends Polymer.Element {
      static get is() {
        return "color-palette";
      }

      static get properties() {
        return {
          hue: {
            type: Number,
            value: 300
          },
          saturation: {
            type: Number,
            value: 100
          },
          lightness: {
            type: Number,
            value: 50
          },
          alpha: {
            type: Number,
            value: 1
          },
          color: {
            type: String,
            observer: "_parseColors"
          }
        }
      }

      static get observers() {
        return [
          "_drawColorBox(hue,alpha)",
          "_drawColorSlider1(saturation,lightness,alpha)",
          "_drawColorSlider2(hue,saturation,lightness)"
        ]
      }

      _drawColorBox(h, a) {
        const c = this.$.colorBox.getContext("2d");
        c.clearRect(0, 0, c.canvas.width, c.canvas.height);
        const sx = c.canvas.width / 50;
        const sy = c.canvas.height / 50;
        for (let l = 0; l < 50; l++) {
          for (let s = 0; s < 50; s++) {
            c.fillStyle = ColorPalette.makeColor(h, s * 2, l * 2, a);
            c.fillRect(sx * l, sy * (49 - s), sx, sy);
          }
        }
      }

      _drawColorSlider1(s,l,a) {
        var c = this.$.colorSlider1.getContext("2d");
        c.clearRect(0,0,c.canvas.width,c.canvas.height);
        var sx = c.canvas.width;
        for (var y = 0; y < c.canvas.height; y++) {
          let h = y/c.canvas.height*360;
          c.fillStyle = ColorPalette.makeColor(h, s, l, a);
          c.fillRect(0, y, sx, 1);
        }
      }

      _drawColorSlider2(h, s, l) {
        const c = this.$.colorSlider2.getContext("2d");
        c.clearRect(0, 0, c.canvas.width, c.canvas.height);
        const sx = c.canvas.width;
        const sy = c.canvas.height;
        for (let a = 0; a < 1; a += 0.01) {
          c.fillStyle = ColorPalette.makeColor(h, s, l, a);
          c.fillRect(0, sy * (0.99 - a), sx, sy * 0.01);
        }
      }

      _parseColors(hsla) {
        let arr = hsla.slice(5,-1).split(",").map( i => i.replace("%", "") );
        this.setProperties({
          "hue": Number(arr[0]),
          "saturation": Number(arr[1]),
          "lightness": Number(arr[2]),
          "alpha": Number(arr[3])
        });
      }

      _hueChange(e) {
        const hue = Math.round(e.detail/this.$.colorSlider1.height*360);
        this._fire("new-color", ColorPalette.makeColor(hue, this.saturation, this.lightness, this.alpha));
      }

      _saturationChange(e) {
        const saturation = Math.round((1-(e.detail/this.$.colorBox.height))*100);
        this._fire("new-color", ColorPalette.makeColor(this.hue, saturation, this.lightness, this.alpha));
      }

      _lightnessChange(e) {
        const lightness = Math.round(e.detail/this.$.colorBox.width*100);
        this._fire("new-color", ColorPalette.makeColor(this.hue, this.saturation, lightness, this.alpha));
      }

      _alphaChange(e) {
        const alpha = ColorPalette.roundTo(1 - (e.detail / this.$.colorSlider2.height), 2);
        this._fire("new-color", ColorPalette.makeColor(this.hue, this.saturation, this.lightness, alpha));
      }

      _calcFromHue(h) {
        return h / 360 * this.$.colorSlider1.height;
      }

      _calcFromSaturation(s) {
        return (1 - s / 100) * this.$.colorBox.height;
      }

      _calcFromLightness(l) {
        return l / 100 * this.$.colorBox.width;
      }

      _calcFromAlpha(a) {
        return (1 - a) * this.$.colorSlider2.height;
      }

      _validate(e) {
        if (e.target.validate())
          this[e.target.dataset.type] = e.target.value;
      }

      static makeColor(h, s, l, a) {
        return "hsla(" + h + ", " + s + "%, " + l + "%, " + a + ")";
      }

      static roundTo(x, n) {
        const e = Math.pow(10, n);
        return Math.round(x * e) / e;
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }
    }
    customElements.define(ColorPalette.is, ColorPalette);
  </script>
</dom-module>