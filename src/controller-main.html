<link rel="import" href="controller-ui.html">
<link rel="import" href="controller-data.html">
<link rel="import" href="controller-fluid.html">
<link rel="import" href="controller-history.html">

<dom-module id="controller-main">
  <template>
    <style>
      :host { height: 100%; }
    </style>
    <controller-history id="history" state="{{state}}" now="[[snap]]"></controller-history>
    <controller-data id="data" state="[[state]]" on-snap-change="_serverUserSnapChange"></controller-data>
    <controller-fluid id="fluid" state="[[state]]" on-snap-change="_fluidSnapChange">
      <controller-ui id="ui" state="[[state]]"></controller-ui>
    </controller-fluid>

  </template>

  <script>

    class ControllerMain extends Polymer.Element {
      static get is() {
        return "controller-main";
      }

      static get properties() {
        return {
          state: Object,
          defaultSnap: Object,
          messagesSnap: Object,
          serverUserSnap: Object,
          fluidSnap: Object,
          userFluidSnap: {
            type: Object,
            computed: "_mergeUserFluid(serverUserSnap, fluidSnap)"
          },
          userSnap: {
            type: Object,
            computed: "_mergeUser(defaultSnap, userFluidSnap)"
          },
          snap: {
            type: Object,
            computed: "_mergeTree(userSnap, messagesSnap)"
          },
          actionType: String
        }
      }

      constructor() {
        super();
        this.addEventListener("system-message", this._systemMessage.bind(this));
        this.addEventListener("system-error", this._systemMessage.bind(this));
        this.addEventListener("help-message", this._helpMessage.bind(this));
        this.addEventListener("sign-in", this._signIn.bind(this));
        this.addEventListener("sign-out", this._signOut.bind(this));
        this.setProperties({
          messagesSnap: {},
          defaultSnap: {viewPort: {x: 0, y: 0, s: 1}, route: HashRouter.parseUrl("unsaved")}
        });
      }

      _fluidSnapChange(e) {
        this.set("actionType", e.detail.type);
        //if (e.detail.type === "something that will change the active sketch)
        //  this.$.data.flushSaveChangesDebouncer();
        this.$.data.saveChangesDebounced(e.detail.snap);
        this._lastIn = e.detail.snap;
        this.set("fluidSnap", e.detail.snap);
      }

      _serverUserSnapChange(e) {
        this.set("actionType", e.detail.type);
        this.$.fluid.reduceFluid(e.detail.snap);    //3. because filter the fluidSnap must be done (this.fluidSnap is updated immediately)
        this._lastIn = e.detail.snap;
        this.set("serverUserSnap", e.detail.snap);  //2. set the serverUserSnap
      }

      _mergeTree(A, B) {
        if (A === undefined || B === undefined || this._inactive)
          return this.snap;
        let C = Tools.mergeDeepWithNullToDelete(A, B);
        C.action = {type: this.actionType, timeStamp: new Date().getTime()};
        return C;
      }

      _mergeUserFluid(A, B) {
        if (A === undefined || B === undefined)
          return this.userFluidSnap;
        if (this._lastIn === A)
          return Tools.mergeDeepWithNullToDelete(B, A);
        return Tools.mergeDeepWithNullToDelete(A, B);
      }

      _mergeUser(A, B) {
        if (A === undefined || B === undefined)
          return this.userSnap;
        return Tools.mergeDeepWithNullToDelete(A, B);
      }

      _signIn() {
        this.$.data.signIn();
      }

      _signOut() {
        this._inactive = true;            //        this.set("active", false);  //synchronic state action start
        this.$.data.signOut();
        this.$.fluid.reset();
        this._inactive = false;           //        this.set("active", true);   //synchronic state action stop
        this.set("defaultSnap", Object.assign({}, this.defaultSnap));
      }

      _systemMessage(e) {
        this.set("actionType", "system-message");
        this.set("messagesSnap", Tools.setIn(this.messagesSnap, ["systemMessage"], e.detail));
      }

      _helpMessage(e) {
        this.set("actionType", "help-message");
        this.set("messagesSnap", Tools.setIn(this.messagesSnap, ["helpMessage"], e.detail));
      }
    }
    customElements.define(ControllerMain.is, ControllerMain);
  </script>
</dom-module>