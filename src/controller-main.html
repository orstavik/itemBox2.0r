<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="controller-ui.html">

<dom-module id="controller-main">
  <template>
    <style>
      :host { height: 100%; }
    </style>

    <controller-ui state="[[state]]"
                   on-change-shapes="_changeShapes"
                   on-deselect-all="_deselect"
                   on-select="_selectSingle"
                   on-shape-location="_registerUIshape"
                   on-new-box-selection="_select"
                   on-view-changed="_viewChanged">
    </controller-ui>

  </template>

  <script>

    class ControllerMain extends Polymer.Element {
      static get is() {
        return "controller-main";
      }

      static get properties() {
        return {
          defaultState: {
            type: State,
            value: function () {
              const shapes = {};
              for (let i = 0; i < 20; i++)
                shapes["shape" + i] = {matrix: MatrixData.random(), selected: false};
              return new State(new ViewPort(0, 0, 1), shapes);
            }
          },
          fluidState: {
            type: State,
            value: function(){
              return new State();
            }
          },
          state:{
            type: Object,
            computed: "_mergeFinal(defaultState, fluidState)"
          }
        }
      }

      _mergeFinal(defaultState, fluidState){
        return defaultState.merge(fluidState);
      }

      _changeShapes(e) {
        this.set("fluidState", this.fluidState.merge({shapes: e.detail}));
      }

      _registerUIshape(e) {
        this.set("fluidState", this.fluidState.merge({shapes: e.detail}));
      }

      _deselect() {
        const shapes = Object.assign({}, this.fluidState.shapes);
        for (let key in shapes)
          shapes[key].selected = false;
        this.set("fluidState", new State(this.fluidState.viewPort, shapes));
      }

      _selectSingle(e) {
        let res = {};
        res[e.detail] = {selected: true};
        this._select({detail: res});
      }

      _select(e) {
        this.set("fluidState", this.fluidState.mergeShapes(e.detail));
      }

      _viewChanged(e) {
        this.set("fluidState", new State(e.detail, this.fluidState.shapes));
      }
    }
    customElements.define(ControllerMain.is, ControllerMain);
  </script>
</dom-module>