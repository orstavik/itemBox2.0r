<link rel="import" href="controller-ui.html">
<link rel="import" href="controller-data.html">
<link rel="import" href="controller-fluid.html">

<dom-module id="controller-main">
  <template>
    <style>
      :host { height: 100%; }
    </style>
    <controller-data id="data" state="[[state]]" server-state="{{serverUserState}}"></controller-data>
    <controller-fluid id="fluid" state="[[state]]" fluid-state="{{fluidState}}">
      <controller-ui state="[[state]]" history="[[history]]"></controller-ui>
    </controller-fluid>

  </template>

  <script>

    class ControllerMain extends Polymer.Element {
      static get is() {
        return "controller-main";
      }

      static get properties() {
        return {
          history: Array,
          defaultState: Object,
          messagesState: Object,
          serverUserState: Object,
          fluidState: Object,
          userState: {
            type: Object,
            computed: "_mergeUser(defaultState, serverUserState)"
          },
          userFluidState: {
            type: Object,
            computed: "_mergeUserFluid(userState, fluidState)"
          },
          messagesUserFluidState: {
            type: Object,
            computed: "_mergeMessagesUserFluidState(userFluidState, messagesState)"
          },
          state: {
            type: Object,
            computed: "_processState(messagesUserFluidState)",
            observer: "_stateChanged"

          },
          active: Boolean,
        }
      }

      constructor() {
        super();
        this.addEventListener("system-message", this._systemMessage.bind(this));
        this.addEventListener("system-error", this._systemMessage.bind(this));
        this.addEventListener("help-message", this._helpMessage.bind(this));
        this.addEventListener("sign-in", this._signIn.bind(this));
        this.addEventListener("sign-out", this._signOut.bind(this));
        this.setProperties({
          history: [],
          messagesState: {systemMessages: {}, helpMessages: {}},
          defaultState: {viewPort: {x: 0, y: 0, s: 1}, route: HashRouter.parseUrl("unsaved")}
        });
        setTimeout(function () {      //todo it works without the setTimeout 0, but can we trust it..
          this.set("active", true);   //by waiting until all the other state properties are set before we activate the merge funnel, we avoid bugs due to racce conditions
          this.set("defaultState", Object.assign({}, this.defaultState));
        }.bind(this), 0);
      }

      _mergeMessagesUserFluidState(A, B) {
        return this.active ? Tools.mergeDeepWithNullToDelete(A, B) : this.messagesUserFluidState;
      }

      _mergeUserFluid(A, B) {
        return this.active ? Tools.mergeDeepWithNullToDelete(A, B) : this.userFluidState;
      }

      _mergeUser(A, B) {
        return this.active ? Tools.mergeDeepWithNullToDelete(A, B) : this.userState;
      }

      //todo syclical structures ALLOWED here, adding branches to the state that are not DAG.
      //processing of the state in the coontroller UI makes the state easier to work with in the UI
      //its purpose is to prepare the view for different things
      _processState(C) {
        if (!this.active)
          return this.state;
        C = Object.assign({}, C);
//        C.shapes = C.sketches.test.shapes;
        C.shapes = Tools.filterPath(C.shapes, null, null);
        C.selecteds = Tools.matchesPathValue(C.shapes, [null, "selected"], true);
        return C;
      }

      _stateChanged(state) {
        this.set("history", this.history.concat([state]));
      }

      _signIn() {
        this.$.data.signIn();
      }

      _signOut() {
        this.active = false;              //synchronic state action start
        this.$.data.signOut();
        this.$.fluid.reset();
        this.active = true;               //synchronic state action stop
        this.set("defaultState", Object.assign({}, this.defaultState)); //redo the state tree
      }

      _systemMessage(e) {
        this.set("messagesState", Tools.setIn(this.messagesState, ["systemMessages", Tools.genKey()], e.detail));
      }

      _helpMessage(e) {
        this.set("messagesState", Tools.setIn(this.messagesState, ["helpMessages", Tools.genKey()], e.detail));
      }
    }
    customElements.define(ControllerMain.is, ControllerMain);
  </script>
</dom-module>