<link rel="import" href="controller-ui.html">
<link rel="import" href="controller-data.html">
<link rel="import" href="controller-route.html">
<link rel="import" href="controller-fluid.html">

<dom-module id="controller-main">
  <template>
    <style>
      :host { height: 100%; }
    </style>
    <controller-route id="route" route-in="[[state.route.url]]"></controller-route>

    <controller-data id="data" server-state="{{serverUserState}}" state="[[state]]"></controller-data>

    <controller-fluid state="[[state]]" fluid-state="{{fluidState}}">
      <controller-ui state="[[state]]" history="[[history]]"></controller-ui>
    </controller-fluid>

  </template>

  <script>

    class ControllerMain extends Polymer.Element {
      static get is() {
        return "controller-main";
      }

      static get properties() {
        return {
          history: Array,
          defaultState: Object,
          serverUserState: Object,
          routeState: Object,
          fluidState: Object,
          userState: {
            type: Object,
            computed: "_merge(defaultState, serverUserState)"
          },
          userFluidState: {
            type: Object,
            computed: "_merge(userState, fluidState)"
          },
          routedUserFluidState: {
            type: Object,
            computed: "_merge(userFluidState, routeState)"
          },
          state: {
            type: Object,
            computed: "_process(routedUserFluidState)",
            observer: "_stateChanged"
          }
        }
      }

      constructor(){
        super();
        this.addEventListener("route-changed", this._routeChanged.bind(this));
        this.addEventListener("system-message", this._systemMessage.bind(this));
        this.addEventListener("system-error", this._systemMessage.bind(this));
        this.addEventListener("help-message", this._helpMessage.bind(this));
        this.addEventListener("sign-in", this._signIn.bind(this));
        this.addEventListener("sign-out", this._signOut.bind(this));
        this.setProperties({
          history: [],
          defaultState: {viewPort: {x: 0, y: 0, s: 1}, route: {url: "unsaved"}}
        });
      }

      _merge(A, B) {
        return Tools.mergeDeepWithNullToDelete(A, B);
      }

      //todo syclical structures ALLOWED here, adding branches to the state that are not DAG.
      //processing of the state in the coontroller UI makes the state easier to work with in the UI
      //its purpose is to prepare the view for different things
      _process(C) {
        C = Object.assign({}, C);
        C.date = new Date();
        C.route = ControllerRoute.parseUrl(C.route.url);
//        C.shapes = C.sketches.test.shapes;
        C.shapes = Tools.filterPath(C.shapes, null, null);
        C.selecteds = Tools.matchesPathValue(C.shapes, [null, "selected"], true);
        return C;
      }

      _stateChanged(C) {
        if (!this._addToTimeMachine)
          return;
        this.push("history", C);
        this._addToTimeMachine = false;
      }

      _routeChanged(e) {
        let route = undefined;
        if (e.detail !== "")
          route = {route: {url: e.detail}};
        this.set("routeState", route);
      }

      _signIn() {
        this.$.data.signIn();
      }

      _signOut() {
        this.$.data.signOut();
        this.$.fluid.reset();
      }

      _systemMessage(e) {
        this.$.fluid.setPath(["systemMessages", Tools.genKey()], e.detail);
      }

      _helpMessage(e) {
        this.$.fluid.setPath(["helpMessages", Tools.genKey()], e.detail);
      }
    }
    customElements.define(ControllerMain.is, ControllerMain);
  </script>
</dom-module>