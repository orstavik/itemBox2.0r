<link rel="import" href="controller-ui.html">
<link rel="import" href="controller-data.html">

<dom-module id="controller-main">
  <template>
    <style>
      :host { height: 100%; }
    </style>

    <!--<controller-data id="data"
                     server-user="{{serverUser}}"
                     user-state="{{serverUserState}}"
                     sketches="{{persistedGenericState}}"

                     on-system-error="_systemError"></controller-data>-->

    <controller-ui state="[[state]]"
                   history="[[history]]"
                   on-new-scale="_newScale"
                   on-add-shape="_addShape"
                   on-change-shapes="_changeShapes"
                   on-change-shapes-end="_changeShapesEnd"
                   on-delete-selected="_deleteSelected"
                   on-deselect-all="_deselect"
                   on-select="_selectSingle"
                   on-shape-location="_registerUIshape"
                   on-new-box-selection="_select"
                   on-view-changed="_viewChanged">
    </controller-ui>

  </template>

  <script>

    class ControllerMain extends Polymer.Element {
      static get is() {
        return "controller-main";
      }

      static get properties() {
        return {
          history: Array,
          defaultState: Object,
          fluidState: Object,
          state: {
            type: Object,
            computed: "_mergeFinal(defaultState, fluidState)",
            observer: "_stateChanged"
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
//        this._unfilteredTimeMachine = [];
        this.setProperties({
          history: [],
          fluidState: {},
          defaultState: {viewPort: {x: 0, y: 0, s: 1}}
        });
        this.addEventListener("system-message", this._systemMessage.bind(this));
        this.addEventListener("help-message", this._helpMessage.bind(this));
      }

      _mergeFinal(A, B) {
        const C = Tools.mergeDeepWithNullToDelete(A, B);
        return this._postProcess(C);
      }

      //todo the parts that happens in the postProcess IS ALLOWED TO make structures that are SYCLICAL,
      //todo adding branches to the state that are not DAG.
      _postProcess(C) {
        C = Object.assign({}, C);   //todo should we do mutating changes on C instead of this??
        C.date = new Date();
        C.shapes = Tools.filterPath(C.shapes, null, null);
        C.selecteds = Tools.matchesPathValue(C.shapes, [null, "selected"], true);
//        this._unfilteredTimeMachine.push(C);
        return C;
      }

      _stateChanged(C) {
        if (!this._addToTimeMachine)
          return;
        this.push("history", C);
        this._addToTimeMachine = false;
      }

      _changeShapesEnd() {
        this._addToTimeMachine = true;
        this.set("fluidState", Object.assign({}, this.fluidState));
      }

      _changeShapes(e) {
        let merged = Tools.mergeDeepWithNullToDelete(this.fluidState, {shapes: e.detail});
        merged.action = "change";             //todo adding type of action to the state.
        this.set("fluidState", merged);
      }

      _addShape(e) {
        this._addToTimeMachine = true;
        let newState = Tools.pushIn(this.fluidState, ["shapes"], {matrix: e.detail});
        newState.action = "add";             //todo adding type of action to the state.
        this.set("fluidState", newState);
      }

      _deleteSelected(e) {
        this._addToTimeMachine = true;
        let dels = {shapes: {}};
        Object.keys(this.state.selecteds).map(key => dels.shapes[key] = null);
        let filtered = Tools.mergeDeepWithNullToDelete(this.fluidState, dels);
        filtered.action = "del";             //todo adding type of action to the state.
        this.set("fluidState", filtered);
      }

      _newScale(e) {
        console.log(e);
      }

      _registerUIshape(e) {
        this.set("fluidState", Tools.setIn(this.fluidState, ["shapes"].concat(e.detail.path), e.detail.value));
      }

      _deselect() {
        let newState = Tools.setInPathWithNullAsWildCard(this.fluidState, ["shapes", null, "selected"], false);
        this.set("fluidState", newState);
      }

      _selectSingle(e) {
        this.set("fluidState", Tools.setIn(this.fluidState, ["shapes", e.detail, "selected"], true));
      }

      _select(e) {
        this.set("fluidState", Tools.mergeDeepWithNullToDelete(this.fluidState, {shapes: e.detail}));
      }

      _viewChanged(e) {
        this.set("fluidState", Tools.mergeDeepWithNullToDelete(this.fluidState, {viewPort: e.detail}));
      }

      _systemMessage(e) {
        this.set("fluidState", Tools.pushIn(this.fluidState, ["systemMessages"], e.detail));
      }

      _helpMessage(e) {
        this.set("fluidState", Tools.pushIn(this.fluidState, ["helpMessages"], e.detail));
      }
    }
    customElements.define(ControllerMain.is, ControllerMain);
  </script>
</dom-module>