<link rel="import" href="controller-ui.html">
<link rel="import" href="controller-data.html">
<link rel="import" href="controller-fluid.html">

<dom-module id="controller-main">
  <template>
    <style>
      :host { height: 100%; }
    </style>
    <controller-data id="data" state="[[activeState]]" server-state="{{serverUserState}}"></controller-data>
    <controller-fluid id="fluid" state="[[activeState]]" fluid-state="{{fluidState}}">
      <controller-ui state="[[activeState]]" history="[[history]]"></controller-ui>
    </controller-fluid>

  </template>

  <script>

    class ControllerMain extends Polymer.Element {
      static get is() {
        return "controller-main";
      }

      static get properties() {
        return {
          history: Array,
          defaultState: Object,
          messagesState: Object,
          serverUserState: Object,
          fluidState: Object,
          userState: {
            type: Object,
            computed: "_merge(defaultState, serverUserState)"
          },
          userFluidState: {
            type: Object,
            computed: "_merge(userState, fluidState)"
          },
          messagesUserFluidState: {
            type: Object,
            computed: "_merge(userFluidState, messagesState)"
          },
          state: {
            type: Object,
            computed: "_process(messagesUserFluidState)"
          },
          active: Boolean,
          activeState: Object
        }
      }

      static get observers() {
        return [
          "_stateChanged(state)",
          "_activeStateChanged(active,state)",
        ];
      }

      constructor() {
        super();
        this.addEventListener("system-message", this._systemMessage.bind(this));
        this.addEventListener("system-error", this._systemMessage.bind(this));
        this.addEventListener("help-message", this._helpMessage.bind(this));
        this.addEventListener("sign-in", this._signIn.bind(this));
        this.addEventListener("sign-out", this._signOut.bind(this));
        this.setProperties({
          history: [],
          messagesState: {systemMessages: {}, helpMessages: {}},
          defaultState: {viewPort: {x: 0, y: 0, s: 1}, route: HashRouter.parseUrl("unsaved")}
        });
        setTimeout(function () {      //todo I don't trust this one without the setTimeout 0, but it works without..
          this.set("active", true);
        }.bind(this), 0);
      }

      _activeStateChanged(active, state) {
        if (active){
          console.log(state);
          this.set("activeState", state);
        }
      }

      _merge(A, B) {
        return Tools.mergeDeepWithNullToDelete(A, B);
      }

      //todo syclical structures ALLOWED here, adding branches to the state that are not DAG.
      //processing of the state in the coontroller UI makes the state easier to work with in the UI
      //its purpose is to prepare the view for different things
      _process(C) {
        C = Object.assign({}, C);
        C.date = new Date();
//        C.shapes = C.sketches.test.shapes;
        C.shapes = Tools.filterPath(C.shapes, null, null);
        C.selecteds = Tools.matchesPathValue(C.shapes, [null, "selected"], true);
        return C;
      }

      _stateChanged(state) {
        if (!this._addToTimeMachine)
          return;
        this.push("history", state);
        this._addToTimeMachine = false;
      }

      _signIn() {
        this.$.data.signIn();
      }

      _signOut() {
        this.$.data.signOut();
        this.$.fluid.reset();
      }

      _systemMessage(e) {
        this.set("messagesState", Tools.setIn(this.messagesState, ["systemMessages", Tools.genKey()], e.detail));
      }

      _helpMessage(e) {
        this.set("messagesState", Tools.setIn(this.messagesState, ["helpMessages", Tools.genKey()], e.detail));
      }
    }
    customElements.define(ControllerMain.is, ControllerMain);
  </script>
</dom-module>