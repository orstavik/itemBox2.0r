<dom-module id="selection-box">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
      }
      #body {
        display: block;
        width: 0;
        height: 0;
        box-sizing: border-box;
        border: 1px dashed crimson;
      }
      #body:not(.active) {
        display: none;
      }
    </style>

    <div id="body" style$="[[_style]]"></div>

  </template>

  <script>

    class SelectionBox extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return "selection-box";
      }

      static get properties() {
        return {
          shapes: Object,
          selected: {
            type: Array,
            value: function () {
              return []
            }
          },
          rect: Object,
          _style: {
            type: String,
            computed: "_makeStyle(rect)"
          }
        }
      }

      constructor() {
        super();
        Polymer.Gestures.addListener(this, "down", e => this._down(e));
        Polymer.Gestures.addListener(this, "track", e => this._track(e));
      }

      _down(e) {
        e.preventDefault();
        this.selected = [];
        this._fire("deselection");         //deselect-all
        this.start = {
          x: e.detail.x,
          y: e.detail.y
        }
      }

      _track(e) {
        e.preventDefault();
        if (e.detail.state == "end") {
          this.$.body.classList.remove("active");
          return;
          // this.dispatchEvent(new CustomEvent("new-box-selection", { composed: true,	bubbles: true, detail: this.selected}));
        }

        this.end = {
          x: e.detail.x,
          y: e.detail.y
        };
        this.set("rect", SelectionBox.makeRectangleFromTwoPoints(this.start, this.end));
        this._selectShapes();
        this.$.body.classList.add("active");
      }

      static makeRectangleFromTwoPoints(start, end) {
        let rect = {};
        rect.left = start.x < end.x ? start.x : end.x;
        rect.top = start.y < end.y ? start.y : end.y;
        rect.right = start.x > end.x ? start.x : end.x;
        rect.bottom = start.y > end.y ? start.y : end.y;
        rect.width = Math.abs(start.x - end.x);
        rect.height = Math.abs(start.y - end.y);
        return rect;
      }

      _makeStyle(r) {
        if (!r)
          return "";
        return "transform: translate(" + r.left + "px," + r.top + "px); " +
               "width: " + r.width + "px; " +
               "height: " + r.height + "px;";
      }

      _selectShapes() {
        for (let key in this.shapes) {
          let shape = this.shapes[key];
          let center = shape.rect.center;
          let index = this.selected.indexOf(shape.id);
          if (center.x >= this.rect.left &&
            center.x <= this.rect.right &&
            center.y >= this.rect.top &&
            center.y <= this.rect.bottom) {
            if (index == -1) {
              this.selected.push(shape.id);
              this._fire("new-box-selection", this.selected);
            }
          } else {
            if (index !== -1) {
              this.selected.splice(index, 1);
              this._fire("new-box-selection", this.selected);
            }
          }
        }
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }
    }
    customElements.define(SelectionBox.is, SelectionBox);
  </script>
</dom-module>