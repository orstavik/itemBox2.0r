<dom-module id="selection-box">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
      }
      :host([active]) #body {
        display: block;
      }
      #body {
        display: none;
        width: 0;
        height: 0;
        box-sizing: border-box;
        border: 1px dashed crimson;
      }
    </style>

    <div id="body" style$="[[_style]]"></div>

  </template>

  <script>

    class SelectionBox extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return "selection-box";
      }

      static get properties() {
        return {
          shapes: Object,
          rect: {
            type: Object,
            observer: "_rectChanged"
          },
          _style: {
            type: String,
            computed: "_makeStyle(rect)"
          },
          active: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          }
        }
      }

      constructor() {
        super();
        Polymer.Gestures.addListener(this, "down", e => this._down(e));
        Polymer.Gestures.addListener(this, "track", e => this._track(e));
      }

      _down(e) {
        e.preventDefault();
        this._fire("deselect-all");
        this.start = e.detail;
      }

      _track(e) {
        e.preventDefault();
        if (e.detail.state == "end")
          return this.set("active", false);

        this.set("rect", Rectangle.makeFromTwoPoints(this.start, e.detail));
        this.set("active", true);
      }

      _makeStyle(r) {
        if (!r)
          return "";
        return "transform: translate(" + r.left + "px," + r.top + "px); " +
          "width: " + r.width + "px; " +
          "height: " + r.height + "px;";
      }

      _rectChanged() {
        let selected = {};
        for (let key in this.shapes) {
          let shape = this.shapes[key];
          selected[key] = {selected: this.rect.pointIsWithinBorders(shape.rect.center)};
        }
        this._fire("new-box-selection", selected);
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }
    }
    customElements.define(SelectionBox.is, SelectionBox);
  </script>
</dom-module>