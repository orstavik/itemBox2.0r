<link rel="import" href="fire-auth.html">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>

<dom-module id="app-data">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>

    <fire-auth id="auth"></fire-auth>

  </template>
  <script>
    class AppData extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return "app-data";
      }

      static get properties() {
        return {
          state: Object,
          user: Object,
          sketchId: {
            type: String,
            observer: '_readCurrentSketch'
          }
        };
      }

      constructor() {
        super();
        window.addEventListener('app-connected', this._appConnected.bind(this));
        // window.addEventListener('online',             this._appOnline.bind(this));
        // window.addEventListener('offline',            this._appOffline.bind(this));

        window.addEventListener('data-sign-in', this._signIn.bind(this));
        window.addEventListener('data-sign-out', this._signOut.bind(this));
        window.addEventListener('data-write-sketch', this._writeSketch.bind(this));
        window.addEventListener('data-write-mouse', this._writeMouse.bind(this));
      }

      async _appConnected() {
        this.user = await this._checkUser();

        let currSketchPromise, sketchListPromise;
        if (this.user) {
          this.fire('state-user-in', this.user);
          currSketchPromise = this._readCurrentSketch();
          sketchListPromise = this._readSketchList();
        } else {
          this.fire('state-user-out');
          currSketchPromise = Promise.resolve();
          sketchListPromise = Promise.resolve();
        }

        this._listenSocket();

        await currSketchPromise, await sketchListPromise;
        this.fire('app-data-loaded');
        this.fire('state-system-message', 'All data loaded!');
      }

      async _signIn() {
        try {
          const result = await this.$.auth.signIn();
          if (result.user) {
            const user = AppData.makeUser(result.user);
            this.fire('state-user-in', user);
            this._readCurrentSketch();
            this._readSketchList();
          }
        } catch (err) {
          throw new Error(err);
        }
      }

      async _signOut() {
        try {
          await this.$.auth.signOut();
          this.navigate('unsaved');
          this.fire('state-user-out');
          this.fire('state-server-sketchlist', null);
        } catch (err) {
          throw new Error(err);
        }
      }

      static makeUser(user) {
        if (!user)
          return user;
        return {
          name: user.displayName,
          email: user.email,
          photo: user.photoURL,
          uid: user.uid
        }
      }

      async _checkUser() {
        const user = await this.$.auth.checkUser();
        return AppData.makeUser(user);
      }

      _listenSocket() {
        this.set('socket', io.connect('https://robotpad-762de.firebaseapp.com:4000'));
        console.log(this.socket);
        this._listenUserMouses();
      }

      async _readCurrentSketch() {
        if (!this.user || this.sketchId === 'unsaved')
          return;

        // read data
        const ref = `/users/${this.user.uid}/sketches/${this.sketchId}`;
        const snapshot = await firebase.database().ref(ref).once('value');
        const currentSketch = snapshot.val();
        if (!currentSketch)
          return this.navigate('unsaved');
        this.fire('state-server-sketch', currentSketch);

        // add new listener
        firebase.database().ref(ref).on('value', snapshot => {
          if (snapshot.key === this.sketchId)
            this.fire('state-server-sketch', snapshot.val());
        });
      }

      async _readSketchList() {
        if (!this.user)
          return;
        const ref = `users/${this.user.uid}/__sketchesOnlyInfo`;
        const snapshot = await firebase.database().ref(ref).once('value');
        const sketchList = snapshot.val();
        this.fire('state-server-sketchlist', sketchList);

        // add new listener
        firebase.database().ref(ref).on('value', snapshot => {
          this.fire('state-server-sketchlist', snapshot.val());
        });
      }

      // mouse experiment
      _listenUserMouses() {
        // firebase.database().ref('mouses').on('value', (snapshot) => {
        //   const mouses = snapshot.val();
        //   for (let key in mouses) {
        //     if (key !== this.user.uid) {
        //       this.fire('state-user-mouse', {mouse: mouses[key], key: key});
        //     }
        //   }
        // });
        this.socket.on('mouse-show', (data) => {
          if (this.socket.id !== data.id)
            this.fire('state-user-mouse', {mouse: data.mouse, key: data.id});
        })
      }

      _writeSketch(e) {
        if (!this.user)
          return;
        this.debounce(async() => {
          console.log(e.type, performance.now());
          const id = e.detail.id;
          const sketch = e.detail.sketch;
          if (id !== 'unsaved') {
            const ref = `users/${this.user.uid}/sketches/${id}`;
            await firebase.database().ref(ref).set(sketch);
          }
        }, 200);
      }

      _writeMouse(e) {
        const mouse = e.detail;
        // if (mouse && this.user) {
        //   const ref = `mouses/${this.user.uid}`;
        //   firebase.database().ref(ref).set(mouse);
        // }
        
        this.socket.emit('mouse-move', {
          mouse: mouse,
          id: this.socket.id
        });
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }));
      }

      debounce(callback, timeout) {
        this._debouncer = Polymer.Debouncer.debounce(
          this._debouncer, // initially undefined
          Polymer.Async.timeOut.after(timeout),
          callback);
      }

      navigate(url) {
        history.pushState({}, null, url);
        window.dispatchEvent(new CustomEvent('location-changed'));
      }
    }
    customElements.define(AppData.is, AppData);
  </script>
</dom-module>