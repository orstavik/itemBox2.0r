<dom-module id="app-state">
  <script>
    class AppState extends Polymer.Element {
      static get is() {
        return "app-state";
      }

      static get properties() {
        return {
          state: {
            type: Object,
            notify: true,
            value: () => ({
              history: {
                all: [],
                sketchEdit: {},
                systemMessages: [],
                helpMessages: []
              }
            })
          },
          initialStatePrst: {
            type: Object,
            value: () => ({
              sketchList: {},
              currentSketch: {
                info: {
                  sketchName: 'unsaved'
                }
              },
              viewPort: {
                x: 0,
                y: 0,
                s: 1
              }
            })
          },
          initialStateSess: {
            type: Object,
            value: () => ({
              editColor: {
                hue: 0,
                saturation: 0,
                lightness: 0,
                alpha: 0
              }
            })
          },
          _frozen: {
            type: Boolean,
            value: true
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();

        window.addEventListener('mousemove', _.throttle(this._mouseMove.bind(this), 1000 / 30));
        window.addEventListener('keydown', _.debounce(this._keyDown.bind(this), 1000 / 30, {
          leading: true,
          trailing: false
        }));
        window.addEventListener('keyup', this._keyUp.bind(this));

        window.addEventListener('state-change-route', this._stateChangeRoute.bind(this));
        window.addEventListener('app-connected', this._appConnected.bind(this));

        window.addEventListener('state-user-in', this._stateUserIn.bind(this));
        window.addEventListener('state-user-out', this._stateUserOut.bind(this));

        window.addEventListener('state-server-sketch', this._stateServerSketch.bind(this));
        window.addEventListener('state-server-sketchlist', this._stateServerSketchList.bind(this));

        window.addEventListener('state-save-sketch', this._stateSaveSketch.bind(this));
        window.addEventListener('state-edit-sketch', this._stateEditSketch.bind(this));
        window.addEventListener('state-delete-sketch', this._stateDeleteSketch.bind(this));

        window.addEventListener('state-add-shape', this._stateAddShape.bind(this));
        window.addEventListener('state-edit-shape', this._stateEditShape.bind(this));
        window.addEventListener('state-move-shape', this._stateEditShapeEnd.bind(this));
        window.addEventListener('state-scale-shape', this._stateEditShapeEnd.bind(this));
        window.addEventListener('state-rotate-shape', this._stateEditShapeEnd.bind(this));
        window.addEventListener('state-delete-shape', this._stateDeleteShape.bind(this));
        window.addEventListener('state-copy-shape', this._stateCopyShape.bind(this));
        window.addEventListener('state-paste-shape', this._statePasteShape.bind(this));

        window.addEventListener('state-preview', this._statePreview.bind(this));
        window.addEventListener('state-revert', this._stateRevert.bind(this));

        window.addEventListener("state-shape-location", this._stateShapeLocation.bind(this));
        window.addEventListener("state-select-shapes", _.throttle(this._stateSelectShapes.bind(this), 1000 / 10)); // THROTTLE FOR BAD SELECTION
        window.addEventListener("state-deselect-shapes", this._stateDeselectShapes.bind(this));

        window.addEventListener("state-change-viewport", _.throttle(this._stateChangeViewport.bind(this), 1000 / 60));
        window.addEventListener("state-change-color", _.throttle(this._stateChangeColor.bind(this), 1000 / 30));

        window.addEventListener("state-system-message", this._stateSystemMessage.bind(this));
        window.addEventListener("state-help-message", this._stateHelpMessage.bind(this));

        // mouse experiment
        window.addEventListener("state-user-mouse", this._stateUserMouse.bind(this));
      }

      _updateState(statePrst, stateSess, action) {
        this.set('state', {
          session: stateSess,
          persistent: statePrst,
          history: AppState.addSnapshot(this.state.history, {
            session: stateSess,
            persistent: statePrst
          }, action)
        });
        if (statePrst)
          this._storeState(statePrst);
      }

      static addSnapshot(history, snapshot, action) {
        const snap = {
          action: action,
          snapshot: snapshot,
          timestamp: new Date().getTime()
        };

        const newHistory = Object.assign(history);
        newHistory.all = [snap].concat(history.all);

        if (['state-add-shape', 'state-delete-shape', 'state-move-shape', 'state-scale-shape', 'state-rotate-shape', 'state-change-color', 'state-revert'].indexOf(action) !== -1) {
          const sketchId = snapshot.session.route.segments[0];
          if (!history.sketchEdit[sketchId])
            history.sketchEdit[sketchId] = []
          newHistory.sketchEdit[sketchId] = [snap].concat(history.sketchEdit[sketchId]);
        }

        if (action === 'state-system-message')
          newHistory.systemMessages = [snap].concat(history.systemMessages);

        return newHistory;
      }

      _storeState(state) {
        localStorage.setItem('state', JSON.stringify(state));
      }

      _getState() {
        return JSON.parse(localStorage.getItem('state'));
      }

      _mouseMove(e) {
        this.mouseTime = performance.now();
        const viewPort = this.state.persistent.viewPort;
        const mouse = {
          x: (e.x-viewPort.x-window.innerWidth/2)/viewPort.s,
          y: (e.y-viewPort.y-window.innerHeight/2)/viewPort.s
        };
        const stateSess = Tools.setIn(this.state.session, ['mouse'], mouse, this._frozen);
        this._updateState(this.state.persistent, stateSess, e.type);
        this.fire('data-write-mouse', mouse);
      }

      _keyDown(e) {
        const key = e.code;
        const stateSess = Tools.setIn(this.state.session, ['keyDowns', key], true, this._frozen);
        this._updateState(this.state.persistent, stateSess, e.type);
      }

      _keyUp(e) {
        const key = e.code;
        const stateSess = Tools.setIn(this.state.session, ['keyDowns', key], false, this._frozen);
        this._updateState(this.state.persistent, stateSess, e.type);
      }

      _stateChangeRoute(e) {
        console.log(e.type, performance.now());
        const route = e.detail;
        let statePrst = this.state.persistent;
        const stateSess = Tools.setIn(this.state.session, ['route'], route, this._frozen);
        if (statePrst) {
          if (stateSess.route.segments[0] === 'unsaved') {
            statePrst = Tools.setIn(statePrst, ['currentSketch'], {
              info: {
                sketchName: 'unsaved'
              }
            }, this._frozen);
          }
        }
        this._updateState(statePrst, stateSess, e.type);
      }

      _appConnected(e) {
        console.log(e.type, performance.now());

        // instantiate state.persistent
        let statePrst = this.state.persistent;
        if (!statePrst) {
          const storedState = this._getState();
          if (storedState) {
            statePrst = Tools.deepFreeze(Object.assign(storedState));
          } else {
            statePrst = Tools.deepFreeze(Object.assign(this.initialStatePrst))
          }
        }

        if (this.state.session.route.segments[0] === 'unsaved') {
          statePrst = Tools.setIn(statePrst, ['currentSketch'], {
            info: {
              sketchName: 'unsaved'
            }
          }, this._frozen);
        }

        // instantiate state.session
        const stateSess = Tools.mergeDeepWithNullToDelete(this.state.session, this.initialStateSess, this._frozen);

        // create snapshot
        this._updateState(statePrst, stateSess, e.type);
      }

      _stateUserIn(e) {
        console.log(e.type, performance.now());
        const user = e.detail;
        const statePrst = Tools.setIn(this.state.persistent, ['user'], user, this._frozen);
        this._updateState(statePrst, this.state.session, e.type);
      }

      _stateUserOut(e) {
        console.log(e.type, performance.now());
        const statePrst = Tools.setIn(this.state.persistent, ['user'], null, this._frozen);
        this._updateState(statePrst, this.state.session, e.type);
      }

      _stateServerSketch(e) {
        console.log(e.type, performance.now());
        let currentSketch = e.detail;
        if (currentSketch === null)
          currentSketch = {
            info: {
              sketchName: 'unsaved'
            }
          };
        const statePrst = Tools.setIn(this.state.persistent, ['currentSketch'], currentSketch, this._frozen);
        this._updateState(statePrst, this.state.session, e.type);
      }

      _stateServerSketchList(e) {
        console.log(e.type, performance.now());
        const sketchList = e.detail;
        let statePrst = Tools.setIn(this.state.persistent, ['sketchList'], sketchList, this._frozen);
        this._updateState(statePrst, this.state.session, e.type);
      }

      _stateSaveSketch(e) {
        console.log(e.type, performance.now());
        //getData for the future
        const sketch = e.detail;
        let currentSketch = {};
        currentSketch.shapes = sketch.clear ? null : (this.state.persistent.currentSketch.shapes || null);
        const key = Tools.genKey();
        //unset the old serverSketch Data and set the new sketchID
        currentSketch.info = sketch.info;
        let statePrst = Tools.setIn(this.state.persistent, ["currentSketch"], currentSketch, this._frozen);
        statePrst = Tools.setIn(statePrst, ["sketchList", key, 'info'], currentSketch.info, this._frozen);
        this._updateState(statePrst, this.state.session, e.type);
        this.fire('data-write-sketch', {
          sketch: currentSketch,
          id: key
        });
        this.navigate(key);
      }

      _stateEditSketch(e) {
        console.log(e.type, performance.now());
        const sketch = e.detail;
        const mergedInfo = Tools.mergeDeepWithNullToDelete(this.state.persistent.currentSketch.info, sketch.info, this._frozen);
        let statePrst = Tools.setIn(this.state.persistent, ["currentSketch", "info"], mergedInfo, this._frozen);
        statePrst = Tools.setIn(statePrst, ["sketchList", sketch.key, "info"], mergedInfo, this._frozen);
        this._updateState(statePrst, this.state.session, e.type);
        this.fire('data-write-sketch', {
          sketch: this.state.persistent.currentSketch,
          id: sketch.key
        });
      }

      _stateDeleteSketch(e) {
        console.log(e.type, performance.now());
        const sketch = e.detail;
        const key = this.state.session.route.segments[0];
        const statePrst = Tools.setIn(this.state.persistent, ["sketchList", sketch.key], null, this._frozen);
        this._updateState(statePrst, this.state.session, e.type);
        this.fire('data-write-sketch', {
          sketch: null,
          id: sketch.key
        });
        if (key === sketch.key)
          this.navigate('unsaved');
      }

      _stateAddShape(e) {
        console.log(e.type, performance.now());
        const shape = Object.assign({}, e.detail);
        if (!shape.color)
          shape.color = this.state.session.editColor
        const statePrst = Tools.setIn(this.state.persistent, ["currentSketch", "shapes", Tools.genKey()], shape, this._frozen);

        this._updateState(statePrst, this.state.session, e.type);

        if (this.state.session.route.segments[0] !== 'unsaved')
          this.fire('data-write-sketch', {
            sketch: this.state.persistent.currentSketch,
            id: this.state.session.route.segments[0]
          });
      }

      _stateEditShape(e) {
        console.log(e.type, performance.now());
        const shapes = e.detail;
        const statePrst = Tools.mergeDeepWithNullToDelete(this.state.persistent, {
          currentSketch: {
            shapes: shapes
          }
        }, this._frozen);

        this._updateState(statePrst, this.state.session, e.type);

        if (this.state.session.route.segments[0] !== 'unsaved')
          this.fire('data-write-sketch', {
            sketch: this.state.persistent.currentSketch,
            id: this.state.session.route.segments[0]
          });
      }

      _stateEditShapeEnd(e) {
        console.log(e.type, performance.now());
        const statePrst = Tools.deepFreeze(Object.assign(this.state.persistent));

        this._updateState(statePrst, this.state.session, e.type);
      }

      _stateDeleteShape(e) {
        console.log(e.type, performance.now());
        let deletes = {};
        for (let key in this.state.session.selected)
          deletes[key] = null;
        const statePrst = Tools.mergeDeepWithNullToDelete(this.state.persistent, {
          currentSketch: {
            shapes: deletes
          }
        }, this._frozen);
        let stateSess = Tools.setIn(this.state.session, ["selected"], {}, this._frozen);
        stateSess = Tools.mergeDeepWithNullToDelete(stateSess, {
          shapeRects: deletes
        }, this._frozen);

        this._updateState(statePrst, stateSess, e.type);

        if (this.state.session.route.segments[0] !== 'unsaved')
          this.fire('data-write-sketch', {
            sketch: this.state.persistent.currentSketch,
            id: this.state.session.route.segments[0]
          });
      }

      _stateCopyShape(e) {
        console.log(e.type, performance.now());
        let clipboard = {};
        for (let key in this.state.session.selected)
          clipboard[key] = Tools.deepClone(this.state.persistent.currentSketch.shapes[key], this._frozen);
        clipboard.mouse = this.state.session.mouse;
        const stateSess = Tools.setIn(this.state.session, ["clipboard"], clipboard, this._frozen);
        this._updateState(this.state.persistent, stateSess, e.type);
      }

      _statePasteShape(e) {
        console.log(e.type, performance.now());
        const clipboard = Tools.deepClone(this.state.session.clipboard);
        const diff = {
          x: this.state.session.mouse.x - clipboard.mouse.x,
          y: this.state.session.mouse.y - clipboard.mouse.y
        };
        for (let key in clipboard) {
          if (key !== 'mouse') {
            let matrix = clipboard[key].matrix;
            matrix.x += diff.x;
            matrix.y += diff.y;
            this.fire('state-add-shape', clipboard[key]);
          }
        }
      }

      _statePreview(e) {
        console.log(e.type, performance.now());
        const state = e.detail;
        this._updateState(state.persistent, state.session, e.type);
      }

      _stateRevert(e) {
        console.log(e.type, performance.now());
        const state = e.detail;
        this._updateState(state.persistent, state.session, e.type);

        if (this.state.session.route.segments[0] !== 'unsaved')
          this.fire('data-write-sketch', {
            sketch: this.state.persistent.currentSketch,
            id: this.state.session.route.segments[0]
          });
      }

      _stateChangeViewport(e) {
        console.log(e.type, performance.now());
        const viewPort = e.detail;
        const statePrst = Tools.setIn(this.state.persistent, ['viewPort'], viewPort, this._frozen);
        this._updateState(statePrst, this.state.session, e.type);
      }

      _stateChangeColor(e) {
        console.log(e.type, performance.now());
        const color = e.detail;
        let colors = {};
        let statePrst = this.state.persistent;
        if (Object.keys(this.state.session.selected).length !== 0) {
          for (let key in this.state.session.selected)
            colors[key] = {
              color: color
            };
          const currentSketch = Tools.mergeDeepWithNullToDelete(this.state.persistent.currentSketch, {
            shapes: colors
          }, this._frozen);
          statePrst = Tools.setIn(this.state.persistent, ["currentSketch"], currentSketch, this._frozen);
        }
        const stateSess = Tools.setIn(this.state.session, ["editColor"], color, this._frozen);

        this._updateState(statePrst, stateSess, e.type);

        if (this.state.session.route.segments[0] !== 'unsaved')
          this.fire('data-write-sketch', {
            sketch: this.state.persistent.currentSketch,
            id: this.state.session.route.segments[0]
          });
      }

      _stateShapeLocation(e) {
        console.log(e.type, performance.now());
        const shapeLocation = e.detail;
        const stateSess = Tools.setIn(this.state.session, ["shapeRects", shapeLocation.key], shapeLocation.value, this._frozen);
        this._updateState(this.state.persistent, stateSess, e.type);
      }

      _stateSelectShapes(e) {
        console.log(e.type, performance.now());
        const selected = e.detail;
        let stateSess = Tools.setIn(this.state.session, ["selected"], selected, this._frozen);
        const keys = Object.keys(selected);
        if (keys && keys.length > 0) {
          const key = keys[0];
          const color = this.state.persistent.currentSketch.shapes[key].color;
          stateSess = Tools.setIn(stateSess, ["editColor"], color, this._frozen);
        }
        this._updateState(this.state.persistent, stateSess, e.type);
      }

      _stateDeselectShapes(e) {
        console.log(e.type, performance.now());
        let stateSess = Tools.setIn(this.state.session, ["selected"], {}, this._frozen);
        this._updateState(this.state.persistent, stateSess, e.type);
      }

      _stateSystemMessage(e) {
        console.log(e.type, performance.now());
        const message = e.detail;
        const stateSess = Tools.setIn(this.state.session, ["systemMessage"], message, this._frozen);
        this._updateState(this.state.persistent, stateSess, e.type);
      }

      _stateHelpMessage(e) {
        console.log(e.type, performance.now());
        const message = e.detail;
        const stateSess = Tools.setIn(this.state.session, ["helpMessage"], message, this._frozen);
        this._updateState(this.state.persistent, stateSess, e.type);
      }

      // mouse experiment
      _stateUserMouse(e) {
        console.log('mouseTime: '+(performance.now()-this.mouseTime));
        const mouse = e.detail.mouse;
        const key = e.detail.key;
        const stateSess = Tools.setIn(this.state.session, ["mouses", key], mouse, this._frozen);
        this._updateState(this.state.persistent, stateSess, e.type);
      }

      navigate(url) {
        history.pushState({}, null, url);
        window.dispatchEvent(new CustomEvent('location-changed'));
      }

      fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: detail
        }))
      }
    }
    customElements.define(AppState.is, AppState);
  </script>
</dom-module>